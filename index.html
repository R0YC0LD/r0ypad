<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>R0YPAD STUDIO | PHOENIX v16.0 (STABLE CORE)</title>
    
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;800&family=Inter:wght@400;700;900&family=Orbitron:wght@900&display=swap" rel="stylesheet">

    <style>
        /* =========================================
           CORE CSS (PHOENIX THEME)
           ========================================= */
        :root {
            --bg-void: #050505;
            --bg-panel: #0a0a0c;
            --bg-slat: #111114;
            
            --phoenix-orange: #ff5500;
            --phoenix-gold: #ffaa00;
            --phoenix-red: #ff003c;
            --phoenix-blue: #00f3ff;
            
            --border: #333;
            --glass: rgba(10,10,12,0.95);
            
            --h-head: 70px;
            --h-mix: 300px;
        }

        * { box-sizing: border-box; user-select: none; outline: none; }
        
        body {
            margin: 0; padding: 0; background: var(--bg-void); color: #eee;
            font-family: 'Inter', sans-serif; height: 100vh; width: 100vw;
            overflow: hidden; display: grid;
            grid-template-rows: var(--h-head) 1fr var(--h-mix);
        }

        /* Scrollbars */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #000; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--phoenix-orange); }

        /* =========================================
           1. BOOT SCREEN (ZORUNLU BAŞLANGIÇ)
           ========================================= */
        #boot-layer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 99999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        
        .logo-big {
            font-family: 'Orbitron'; font-size: 5rem; letter-spacing: 10px;
            background: linear-gradient(to bottom, #fff, var(--phoenix-orange));
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            margin-bottom: 20px; text-shadow: 0 0 50px var(--phoenix-orange);
        }
        
        .boot-status {
            font-family: 'JetBrains Mono'; color: #666; font-size: 12px; margin-bottom: 40px;
        }

        #btn-start-engine {
            padding: 20px 60px; background: transparent; 
            border: 2px solid var(--phoenix-orange); color: var(--phoenix-orange);
            font-family: 'Orbitron'; font-size: 20px; cursor: pointer;
            transition: 0.3s; letter-spacing: 2px;
        }
        #btn-start-engine:hover {
            background: var(--phoenix-orange); color: #000; box-shadow: 0 0 50px var(--phoenix-orange);
        }

        /* =========================================
           2. HEADER
           ========================================= */
        header {
            background: var(--bg-panel); border-bottom: 1px solid var(--border);
            padding: 0 20px; display: flex; align-items: center; justify-content: space-between;
            box-shadow: 0 10px 30px #000; z-index: 100;
        }

        .brand { font-family: 'Orbitron'; font-size: 24px; color: #fff; }
        .brand span { color: var(--phoenix-orange); }

        .toolbar { display: flex; gap: 10px; align-items: center; }

        .btn {
            height: 36px; padding: 0 15px; border-radius: 4px; font-weight: 700; font-size: 11px;
            cursor: pointer; border: 1px solid var(--border); background: var(--bg-slat); color: #ccc;
            display: flex; align-items: center; gap: 6px; transition: 0.2s;
        }
        .btn:hover { border-color: #666; color: #fff; }
        
        .btn-add { border-color: var(--phoenix-blue); color: var(--phoenix-blue); }
        .btn-add:hover { background: var(--phoenix-blue); color: #000; }
        
        .btn-ai { border-color: var(--phoenix-gold); color: var(--phoenix-gold); }
        .btn-ai:hover { background: var(--phoenix-gold); color: #000; }

        .transport {
            display: flex; background: #000; padding: 5px; border-radius: 4px; border: 1px solid var(--border); gap: 5px;
        }
        .btn-tr { width: 40px; height: 30px; background: #111; border: none; color: #666; cursor: pointer; border-radius: 2px; font-size: 14px; }
        .btn-tr:hover { color: #fff; background: #222; }
        .btn-play.active { color: #000; background: var(--phoenix-gold); }
        .btn-stop:hover { color: var(--phoenix-red); }

        .bpm-in { background: none; border: none; color: var(--phoenix-blue); width: 40px; text-align: center; font-weight: bold; font-family: 'JetBrains Mono'; font-size: 14px; }

        /* =========================================
           3. SEQUENCER
           ========================================= */
        .workspace {
            position: relative; background: #08080a; overflow-y: auto; padding: 20px;
            background-image: linear-gradient(#151515 1px, transparent 1px); background-size: 100% 60px;
        }

        .track-list { display: flex; flex-direction: column; gap: 5px; padding-bottom: 100px; }

        .track-row {
            display: flex; height: 55px; background: var(--bg-slat);
            border: 1px solid var(--border); border-radius: 4px;
        }
        .track-row.playing { border-left: 3px solid var(--phoenix-orange); background: #1a1a1d; }

        .t-head {
            width: 180px; padding: 0 15px; border-right: 1px solid var(--border);
            display: flex; align-items: center; justify-content: space-between;
        }
        .t-name { font-weight: bold; color: #fff; font-size: 12px; }
        .t-btn { width: 20px; height: 20px; background: #000; border: 1px solid #333; color: #666; font-size: 9px; display: flex; align-items: center; justify-content: center; cursor: pointer; border-radius: 3px; }
        .t-btn:hover { color: var(--phoenix-red); border-color: var(--phoenix-red); }

        .t-grid { flex: 1; display: grid; grid-template-columns: repeat(16, 1fr); gap: 2px; padding: 5px; }
        .step {
            background: #000; border: 1px solid #222; border-radius: 2px; cursor: pointer;
        }
        .step:nth-child(4n+1) { background: #0c0c0e; }
        .step:hover { border-color: #555; }
        .step.active { background: var(--phoenix-orange); box-shadow: 0 0 10px var(--phoenix-orange); border-color: var(--phoenix-orange); }
        .step.playhead { background: #fff !important; transform: scale(1.1); z-index: 10; }

        /* =========================================
           4. MIXER
           ========================================= */
        .mixer {
            background: var(--bg-panel); border-top: 1px solid var(--border);
            padding: 15px; display: flex; gap: 10px; overflow-x: auto;
            box-shadow: 0 -10px 50px #000; z-index: 50;
        }

        .strip {
            width: 90px; height: 100%; background: var(--bg-slat);
            border: 1px solid var(--border); border-radius: 4px;
            display: flex; flex-direction: column; padding: 10px; flex-shrink: 0;
        }
        .strip.master { margin-left: auto; width: 110px; border-color: var(--phoenix-gold); background: #0f0b05; }

        .s-title { text-align: center; font-size: 9px; font-weight: bold; color: #666; margin-bottom: 10px; text-transform: uppercase; white-space: nowrap; overflow: hidden; }
        .master .s-title { color: var(--phoenix-gold); }

        .fx-list { display: flex; flex-direction: column; gap: 4px; margin-bottom: 10px; }
        .fx-btn {
            font-size: 8px; background: #000; color: #555; padding: 4px; text-align: center;
            border: 1px solid #222; cursor: pointer; border-radius: 2px;
        }
        .fx-btn:hover { color: #fff; border-color: #555; }
        .fx-btn.on { color: var(--phoenix-blue); border-color: var(--phoenix-blue); background: rgba(0, 243, 255, 0.1); }

        .fader-box { flex: 1; display: flex; justify-content: center; position: relative; }
        
        input[type=range].vol {
            -webkit-appearance: none; width: 150px; height: 20px; background: transparent;
            transform: rotate(-90deg); margin-top: 65px; cursor: ns-resize;
        }
        input[type=range].vol::-webkit-slider-thumb {
            -webkit-appearance: none; width: 12px; height: 24px; background: #444;
            border: 1px solid #000; border-radius: 2px; box-shadow: 0 2px 5px #000;
        }
        .master input[type=range].vol::-webkit-slider-thumb { background: var(--phoenix-gold); }

        /* =========================================
           5. MODALS & DEBUG
           ========================================= */
        .overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 5000; display: none;
            justify-content: center; align-items: center;
        }
        .modal { width: 600px; background: var(--bg-slat); border: 1px solid var(--border); border-top: 3px solid var(--phoenix-blue); padding: 20px; }
        
        .lib-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; max-height: 400px; overflow-y: auto; }
        .lib-item { background: #000; padding: 10px; border: 1px solid #333; text-align: center; cursor: pointer; font-size: 11px; }
        .lib-item:hover { border-color: var(--phoenix-blue); color: #fff; }

        .debug-console {
            position: fixed; bottom: 0; left: 0; width: 100%; height: 25px;
            background: #000; border-top: 1px solid #222; color: var(--phoenix-gold);
            font-family: 'JetBrains Mono'; font-size: 10px; display: flex; align-items: center; padding: 0 10px;
            z-index: 9999;
        }

        /* Plugin Window */
        .plugin-win {
            position: absolute; width: 250px; background: rgba(10,10,10,0.95);
            border: 1px solid #444; border-top: 2px solid var(--phoenix-blue);
            top: 30%; left: 40%; display: none; flex-direction: column; z-index: 6000;
            box-shadow: 0 20px 50px #000;
        }
        .pw-head { padding: 8px; background: #222; display: flex; justify-content: space-between; font-weight: bold; font-size: 11px; cursor: move; }
        .pw-body { padding: 15px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        
        .knob-box { text-align: center; }
        input[type=range].knob { width: 100%; cursor: pointer; }

    </style>
</head>
<body>

    <div id="boot-layer">
        <div class="logo-big">PHOENIX</div>
        <div class="boot-status">SES MOTORU BEKLEMEDE...</div>
        <button id="btn-start-engine" onclick="Core.startEngine()">SİSTEMİ BAŞLAT</button>
    </div>

    <div class="debug-console" id="console-line">> SYSTEM READY. WAITING FOR USER INPUT...</div>

    <div class="plugin-win" id="fx-window">
        </div>

    <div class="overlay" id="mod-lib">
        <div class="modal">
            <h3 style="margin-top:0; color:#fff;">ENSTRÜMAN EKLE</h3>
            <div class="lib-grid" id="lib-content"></div>
            <button class="btn" style="margin-top:15px; width:100%; justify-content:center;" onclick="UI.toggle('mod-lib', false)">KAPAT</button>
        </div>
    </div>

    <div class="overlay" id="mod-ai">
        <div class="modal">
            <h3 style="margin-top:0; color:var(--phoenix-gold);">YAPAY ZEKA MİMAR</h3>
            <textarea id="ai-in" style="width:100%; height:100px; background:#000; color:#fff; border:1px solid #333; padding:10px;" placeholder="Tarzınızı yazın (Trap, Techno, Hızlı, Yavaş)..."></textarea>
            <button class="btn btn-ai" style="width:100%; justify-content:center; margin-top:10px; height:40px;" onclick="AI.generate()">OLUŞTUR</button>
        </div>
    </div>

    <header>
        <div class="brand">R0Y<span>PAD</span></div>
        
        <div class="toolbar">
            <button class="btn btn-add" onclick="UI.toggle('mod-lib', true)">+ KANAL</button>
            <button class="btn btn-ai" onclick="UI.toggle('mod-ai', true)">YAPAY ZEKA</button>
            <div style="width:1px; height:20px; background:#333;"></div>
            <div class="transport">
                <span style="font-size:10px; color:#666; font-weight:bold; padding-left:5px;">BPM</span>
                <input type="number" class="bpm-in" id="bpm-val" value="130" onchange="Core.setBpm(this.value)">
                <button class="btn-tr" onclick="Core.stop()">■</button>
                <button class="btn-tr btn-play" id="btn-play" onclick="Core.toggle()">▶</button>
            </div>
            <button class="btn" onclick="Core.clear()">TEMİZLE</button>
        </div>
    </header>

    <div class="workspace">
        <div class="track-list" id="track-container">
            </div>
    </div>

    <div class="mixer" id="mixer-container">
        <div class="strip master">
            <div class="s-title">MASTER</div>
            <div class="fx-list">
                <div class="fx-btn on">LIMITER</div>
                <div class="fx-btn on">COMP</div>
            </div>
            <div class="fader-box">
                <input type="range" class="vol" min="0" max="1.2" step="0.01" value="0.9" oninput="Core.setMaster(this.value)">
            </div>
        </div>
    </div>

<script>
    /**
     * R0YPAD PHOENIX v16.0 - STABLE CORE
     * ----------------------------------
     * Logic:
     * 1. AudioContext is created ONLY after user clicks "BASLAT".
     * 2. Sounds are synthesized (Oscillators) so no loading errors.
     * 3. Simple Scheduler for reliable timing.
     */

    // --- 1. SYSTEM LOGGING ---
    const Log = {
        print: (msg) => {
            const el = document.getElementById('console-line');
            el.innerText = `> ${msg}`;
            el.style.color = '#00f3ff';
            setTimeout(() => el.style.color = '#ffaa00', 200);
            console.log(`[SYS] ${msg}`);
        }
    };

    // --- 2. UTILS ---
    const Utils = {
        id: () => 't_' + Math.random().toString(36).substr(2, 9),
        rand: (min, max) => Math.random() * (max - min) + min,
        // Basit Reverb Impulse
        createImpulse: (ctx) => {
            const len = ctx.sampleRate * 2; // 2 seconds
            const buf = ctx.createBuffer(2, len, ctx.sampleRate);
            for(let i=0; i<len; i++) {
                let dec = Math.pow(1 - i/len, 3);
                buf.getChannelData(0)[i] = (Math.random()*2-1)*dec;
                buf.getChannelData(1)[i] = (Math.random()*2-1)*dec;
            }
            return buf;
        },
        // Distortion Curve
        makeDist: (amount) => {
            const n = 44100, curve = new Float32Array(n);
            for(let i=0; i<n; ++i) {
                const x = i * 2 / n - 1;
                curve[i] = (3 + amount) * x * 20 * (Math.PI / 180) / (Math.PI + amount * Math.abs(x));
            }
            return curve;
        }
    };

    // --- 3. CORE AUDIO ---
    const Core = {
        ctx: null, master: null, limiter: null,
        tracks: [], isPlaying: false, step: 0, nextNoteTime: 0, tempo: 130, timerID: null,

        startEngine() {
            try {
                const AC = window.AudioContext || window.webkitAudioContext;
                this.ctx = new AC();
                
                // Master Bus
                this.master = this.ctx.createGain();
                this.master.gain.value = 0.9;
                
                // Safety Limiter
                this.limiter = this.ctx.createDynamicsCompressor();
                this.limiter.threshold.value = -1.0;
                this.limiter.ratio.value = 20.0;

                this.master.connect(this.limiter);
                this.limiter.connect(this.ctx.destination);

                // UI Update
                document.getElementById('boot-layer').style.display = 'none';
                Log.print("AUDIO ENGINE STARTED SUCCESSFULLY.");
                
                // Default Tracks
                Library.init(); // Init instruments
                
                // Add demo tracks
                this.addTrack(Library.presets[0]); // Kick
                this.addTrack(Library.presets[1]); // Snare
                this.addTrack(Library.presets[2]); // Hat
                
            } catch (e) {
                alert("Tarayıcı Ses Hatası: " + e);
            }
        },

        toggle() {
            if(!this.ctx) return;
            if(this.ctx.state === 'suspended') this.ctx.resume();

            this.isPlaying = !this.isPlaying;
            const btn = document.getElementById('btn-play');
            
            if(this.isPlaying) {
                btn.classList.add('active'); btn.innerText = "||";
                this.step = 0;
                this.nextNoteTime = this.ctx.currentTime + 0.1;
                this.scheduler();
                Log.print("PLAYBACK STARTED");
            } else {
                btn.classList.remove('active'); btn.innerText = "▶";
                clearTimeout(this.timerID);
                Log.print("PLAYBACK PAUSED");
            }
        },

        stop() {
            this.isPlaying = false;
            clearTimeout(this.timerID);
            this.step = 0;
            document.getElementById('btn-play').classList.remove('active');
            document.getElementById('btn-play').innerText = "▶";
            UI.resetHeads();
            Log.print("STOPPED");
        },

        scheduler() {
            const secondsPerBeat = 60.0 / this.tempo;
            const stepTime = 0.25 * secondsPerBeat; // 16th note

            while (this.nextNoteTime < this.ctx.currentTime + 0.1) {
                this.playStep(this.step, this.nextNoteTime);
                this.nextNoteTime += stepTime;
                this.step = (this.step + 1) % 16;
            }
            this.timerID = setTimeout(() => this.scheduler(), 25);
        },

        playStep(stepNum, time) {
            // UI Sync
            const drawTime = (time - this.ctx.currentTime) * 1000;
            setTimeout(() => UI.drawHead(stepNum), Math.max(0, drawTime));

            this.tracks.forEach(tr => {
                if(tr.steps[stepNum] && !tr.muted) {
                    tr.synth.trigger(time);
                }
            });
        },

        addTrack(preset) {
            const t = new Track(this.ctx, this.master, preset);
            this.tracks.push(t);
            UI.renderTrack(t);
            UI.renderStrip(t);
            return t;
        },

        removeTrack(id) {
            const idx = this.tracks.findIndex(t => t.id === id);
            if(idx > -1) {
                this.tracks[idx].kill();
                this.tracks.splice(idx, 1);
                document.getElementById(`tr-${id}`).remove();
                document.getElementById(`ch-${id}`).remove();
                document.getElementById(`win-${id}`)?.remove();
            }
        },

        clear() {
            this.tracks.forEach(t => t.steps.fill(false));
            document.querySelectorAll('.step.active').forEach(e => e.classList.remove('active'));
            Log.print("PATTERN CLEARED");
        },

        setBpm(v) { this.tempo = Math.max(40, Math.min(300, parseInt(v))); Log.print(`BPM SET TO ${this.tempo}`); },
        setMaster(v) { if(this.master) this.master.gain.value = v; }
    };

    // --- 4. TRACK & SYNTH ---
    class Track {
        constructor(ctx, dest, preset) {
            this.ctx = ctx; this.preset = preset;
            this.id = Utils.id();
            this.name = preset.name;
            this.steps = Array(16).fill(false);
            this.muted = false;

            // Audio Graph: Synth -> FX Chain -> Volume -> Master
            this.vol = ctx.createGain();
            this.vol.gain.value = 0.8;
            this.vol.connect(dest);

            // FX Nodes
            this.fx = {
                dist: ctx.createWaveShaper(),
                delay: ctx.createDelay(), dFb: ctx.createGain(),
                rev: ctx.createConvolver(), rGain: ctx.createGain(),
                dry: ctx.createGain()
            };

            // FX Setup
            this.fx.dist.curve = Utils.makeDist(0); this.fx.dist.oversample = '4x';
            this.fx.delay.delayTime.value = 0; this.fx.dFb.gain.value = 0;
            this.fx.delay.connect(this.fx.dFb); this.fx.dFb.connect(this.fx.delay);
            this.fx.rev.buffer = Utils.createImpulse(ctx); this.fx.rGain.gain.value = 0;

            // Wiring
            this.input = this.fx.dist;
            this.fx.dist.connect(this.fx.dry);
            this.fx.dist.connect(this.fx.delay);
            this.fx.dist.connect(this.fx.rev);

            this.fx.dry.connect(this.vol);
            this.fx.delay.connect(this.vol);
            this.fx.rev.connect(this.fx.rGain);
            this.fx.rGain.connect(this.vol);

            this.params = { dist:0, delay:0, rev:0 };
            this.synth = new Synth(this);
        }

        updateFX(type, val) {
            if(type==='DIST') { this.params.dist=val; this.fx.dist.curve = Utils.makeDist(val*2); }
            if(type==='DELAY') { this.params.delay=val; this.fx.delay.delayTime.value = (val/100)*0.5; this.fx.dFb.gain.value=(val/100)*0.6; }
            if(type==='REV') { this.params.rev=val; this.fx.rGain.gain.value = (val/100); }
        }

        kill() { this.vol.disconnect(); }
    }

    class Synth {
        constructor(track) { this.t = track; this.ctx = track.ctx; }
        
        trigger(time) {
            const dest = this.t.input;
            const p = this.t.preset.p;
            const c = this.ctx;

            const osc = c.createOscillator();
            const gain = c.createGain();

            if (this.t.preset.cat === 'KICK') {
                osc.frequency.setValueAtTime(p.freq, time);
                osc.frequency.exponentialRampToValueAtTime(10, time + 0.5);
                gain.gain.setValueAtTime(1, time);
                gain.gain.exponentialRampToValueAtTime(0.001, time + 0.5);
            } else if (this.t.preset.cat === 'SNARE') {
                osc.type = 'triangle'; osc.frequency.setValueAtTime(200, time);
                gain.gain.setValueAtTime(0.5, time); gain.gain.exponentialRampToValueAtTime(0.001, time + 0.1);
                
                // Noise
                const b = c.createBuffer(1, c.sampleRate*0.1, c.sampleRate);
                const d = b.getChannelData(0); for(let i=0;i<d.length;i++) d[i]=Math.random()*2-1;
                const n = c.createBufferSource(); n.buffer = b;
                const ng = c.createGain(); ng.gain.value = 0.5;
                n.connect(ng); ng.connect(dest); n.start(time);
            } else { // Synth/Hat
                osc.type = p.wave || 'square';
                osc.frequency.setValueAtTime(p.freq, time);
                gain.gain.setValueAtTime(0.3, time);
                gain.gain.exponentialRampToValueAtTime(0.001, time + (p.decay || 0.3));
            }

            osc.connect(gain);
            gain.connect(dest);
            osc.start(time);
            osc.stop(time + 1);
        }
    }

    // --- 5. LIBRARY & AI ---
    const Library = {
        presets: [],
        init() {
            for(let i=1;i<=5;i++) this.presets.push({cat:'KICK', name:`Phoenix Kick ${i}`, p:{freq:50+i*5}});
            for(let i=1;i<=5;i++) this.presets.push({cat:'SNARE', name:`Phoenix Snare ${i}`, p:{freq:200}});
            for(let i=1;i<=5;i++) this.presets.push({cat:'HAT', name:`HiHat ${i}`, p:{freq:8000+i*500, wave:'square', decay:0.05}});
            for(let i=1;i<=5;i++) this.presets.push({cat:'BASS', name:`Acid Bass ${i}`, p:{freq:50+i*10, wave:'sawtooth', decay:0.4}});
            
            const g = document.getElementById('lib-content');
            this.presets.forEach(p => {
                const el = document.createElement('div');
                el.className = 'lib-item';
                el.innerText = `${p.name} (${p.cat})`;
                el.onclick = () => { Core.addTrack(p); UI.toggle('mod-lib', false); };
                g.appendChild(el);
            });
        }
    };

    const AI = {
        generate() {
            const val = document.getElementById('ai-in').value.toLowerCase();
            Core.clear();
            Log.print("AI GENERATING...");
            
            let bpm = 130;
            if(val.includes('hızlı') || val.includes('techno')) bpm = 140;
            if(val.includes('yavaş')) bpm = 90;
            Core.setBpm(bpm); document.getElementById('bpm-val').value = bpm;

            const k = Core.addTrack(Library.presets[0]); // Kick
            const s = Core.addTrack(Library.presets[5]); // Snare
            const h = Core.addTrack(Library.presets[10]); // Hat
            
            for(let i=0; i<16; i++) {
                if(i%4 === 0) k.steps[i] = true;
                if(i===4 || i===12) s.steps[i] = true;
                if(i%2 === 0) h.steps[i] = true;
            }
            
            UI.renderTrack(k); UI.renderTrack(s); UI.renderTrack(h); // Refresh UI
            UI.toggle('mod-ai', false);
            Core.toggle();
        }
    };

    // --- 6. UI MANAGER ---
    const UI = {
        toggle(id, show) { document.getElementById(id).style.display = show?'flex':'none'; },
        
        renderTrack(t) {
            // Check if exists
            if(document.getElementById(`tr-${t.id}`)) return; 

            const el = document.createElement('div');
            el.className = 'track-row'; el.id = `tr-${t.id}`;
            el.innerHTML = `
                <div class="t-head">
                    <span class="t-name">${t.name}</span>
                    <div class="t-btn" onclick="Core.removeTrack('${t.id}')">X</div>
                </div>
                <div class="t-grid">
                    ${t.steps.map((_, i) => `<div class="step" id="s-${t.id}-${i}" onclick="UI.step('${t.id}', ${i}, this)"></div>`).join('')}
                </div>
            `;
            document.getElementById('track-container').appendChild(el);
        },

        renderStrip(t) {
            if(document.getElementById(`ch-${t.id}`)) return;

            const el = document.createElement('div');
            el.className = 'strip'; el.id = `ch-${t.id}`;
            el.innerHTML = `
                <div class="s-title">${t.name}</div>
                <div class="fx-list">
                    <div class="fx-btn" onclick="UI.openFX('${t.id}', 'DIST')">DIST</div>
                    <div class="fx-btn" onclick="UI.openFX('${t.id}', 'DELAY')">DELAY</div>
                    <div class="fx-btn" onclick="UI.openFX('${t.id}', 'REV')">REV</div>
                </div>
                <div class="fader-box">
                    <input type="range" class="vol" min="0" max="1" step="0.01" value="0.8" 
                           oninput="Core.tracks.find(x=>x.id=='${t.id}').vol.gain.value=this.value">
                </div>
            `;
            const c = document.getElementById('mixer-container');
            c.insertBefore(el, c.querySelector('.master'));
        },

        step(tid, i, el) {
            const t = Core.tracks.find(x=>x.id===tid);
            if(t) { t.steps[i] = !t.steps[i]; el.classList.toggle('active'); }
        },

        drawHead(s) {
            document.querySelectorAll('.step.playhead').forEach(e => e.classList.remove('playhead'));
            document.querySelectorAll(`.step:nth-child(${s+1})`).forEach(e => e.classList.add('playhead'));
            document.querySelectorAll('.track-row').forEach(r => r.classList.remove('playing'));
            // Optional: Highlight playing row logic
        },
        resetHeads() { document.querySelectorAll('.playhead').forEach(e => e.classList.remove('playhead')); },

        // FX Window
        openFX(tid, type) {
            const pid = `win-${tid}`;
            if(document.getElementById(pid)) document.getElementById(pid).remove();
            
            const t = Core.tracks.find(x=>x.id===tid);
            const w = document.getElementById('fx-window');
            w.id = pid; w.style.display = 'flex';
            
            let val = 0;
            if(type==='DIST') val = t.params.dist;
            if(type==='DELAY') val = t.params.delay;
            if(type==='REV') val = t.params.rev;

            w.innerHTML = `
                <div class="pw-head"><span>${t.name} - ${type}</span><span style="cursor:pointer" onclick="this.parentElement.parentElement.style.display='none'">X</span></div>
                <div class="pw-body">
                    <div class="knob-box">
                        <input type="range" class="knob" min="0" max="100" value="${val}" oninput="Core.tracks.find(x=>x.id=='${tid}').updateFX('${type}', this.value)">
                        <span style="color:#aaa; font-size:10px;">AMOUNT</span>
                    </div>
                </div>
            `;
            // Drag logic
            let isDown = false, offset = [0,0];
            w.querySelector('.pw-head').addEventListener('mousedown', function(e) {
                isDown = true;
                offset = [ w.offsetLeft - e.clientX, w.offsetTop - e.clientY ];
            }, true);
            document.addEventListener('mouseup', function() { isDown = false; }, true);
            document.addEventListener('mousemove', function(e) {
                if (isDown) {
                    w.style.left = (e.clientX + offset[0]) + 'px';
                    w.style.top  = (e.clientY + offset[1]) + 'px';
                }
            }, true);
        }
    };

</script>
</body>
</html>
