<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>R0YPAD STUDIO | ULTIMATE EDITION</title>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;800&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-dark: #09090b;
            --bg-panel: #18181b;
            --bg-lighter: #27272a;
            --accent: #06b6d4; /* Cyan */
            --accent-glow: rgba(6, 182, 212, 0.4);
            --danger: #f43f5e;
            --success: #10b981;
            --text-main: #e4e4e7;
            --text-dim: #71717a;
            --border: #3f3f46;
        }

        * { box-sizing: border-box; user-select: none; -webkit-user-drag: none; scrollbar-width: thin; scrollbar-color: var(--accent) var(--bg-dark); }
        
        body {
            margin: 0; background: var(--bg-dark); color: var(--text-main);
            font-family: 'Inter', sans-serif; height: 100vh; overflow: hidden;
            display: grid; grid-template-rows: 50px 1fr 300px;
        }

        /* --- LOADING SCREEN --- */
        #loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 99999; display: flex; flex-direction: column;
            align-items: center; justify-content: center;
        }
        
        .loader-brand { font-family: 'JetBrains Mono', monospace; font-size: 4rem; font-weight: 800; letter-spacing: -2px; color: #fff; margin-bottom: 20px; text-shadow: 0 0 30px var(--accent); }
        .loader-brand span { color: var(--accent); }
        
        .loader-bar-container { width: 400px; height: 6px; background: #222; border-radius: 3px; overflow: hidden; position: relative; }
        .loader-bar { height: 100%; background: var(--accent); width: 0%; box-shadow: 0 0 10px var(--accent); transition: width 0.3s linear; }
        
        .loader-msg { margin-top: 15px; font-family: 'JetBrains Mono', monospace; font-size: 14px; color: var(--text-dim); height: 20px; }

        /* --- HEADER --- */
        header {
            background: var(--bg-panel); border-bottom: 1px solid var(--border);
            display: flex; align-items: center; justify-content: space-between; padding: 0 20px;
            z-index: 100;
        }
        .logo { font-weight: 800; font-size: 20px; letter-spacing: -1px; }
        .logo span { color: var(--accent); }
        
        .toolbar { display: flex; gap: 10px; }
        .btn {
            background: var(--bg-lighter); border: 1px solid var(--border); color: #fff;
            padding: 6px 14px; border-radius: 6px; font-size: 12px; font-weight: 600;
            cursor: pointer; transition: 0.2s; display: flex; align-items: center; gap: 5px;
        }
        .btn:hover { border-color: var(--accent); color: var(--accent); }
        .btn-primary { background: var(--accent); color: #000; border: none; }
        .btn-primary:hover { background: #22d3ee; box-shadow: 0 0 15px var(--accent-glow); color: #000; }
        .btn-danger { border-color: var(--danger); color: var(--danger); }
        .btn-danger:hover { background: var(--danger); color: white; }

        /* --- WORKSPACE (Sequencer) --- */
        .workspace { position: relative; overflow: hidden; display: flex; }
        .sequencer-area { flex: 1; padding: 20px; overflow-y: auto; background: radial-gradient(circle at top, #1e1e24 0%, var(--bg-dark) 100%); }
        
        .track-row {
            display: flex; height: 52px; margin-bottom: 6px; background: rgba(255,255,255,0.03);
            border-radius: 4px; border-left: 3px solid transparent; transition: 0.1s;
        }
        .track-row:hover { background: rgba(255,255,255,0.06); }
        .track-row.selected { border-left-color: var(--accent); background: rgba(6, 182, 212, 0.1); }

        .track-header { width: 160px; padding: 0 10px; display: flex; flex-direction: column; justify-content: center; border-right: 1px solid rgba(255,255,255,0.05); }
        .t-name { font-weight: 600; font-size: 13px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .t-cat { font-size: 10px; color: var(--text-dim); text-transform: uppercase; }

        .step-grid { flex: 1; display: grid; grid-template-columns: repeat(16, 1fr); gap: 2px; padding: 6px; }
        .step {
            background: #121215; border-radius: 2px; cursor: pointer; position: relative;
        }
        .step:nth-child(4n+1) { background: #1a1a20; } /* Beat markers */
        .step.active { background: var(--accent); box-shadow: 0 0 10px var(--accent-glow); }
        .step.playing { border: 1px solid #fff; z-index: 10; }
        
        /* --- MIXER & PLUGIN RACK --- */
        .mixer-area {
            background: #111; border-top: 1px solid var(--border); display: flex;
            overflow-x: auto; padding: 10px; z-index: 90;
        }
        
        .channel-strip {
            width: 90px; height: 100%; background: var(--bg-panel); border-radius: 6px;
            margin-right: 8px; border: 1px solid var(--border); display: flex; flex-direction: column;
            padding: 8px; position: relative; flex-shrink: 0;
        }
        .channel-strip.master { border-color: var(--accent); background: #0f181a; }

        .fx-slot-container { flex: 1; display: flex; flex-direction: column; gap: 2px; overflow-y: auto; margin-bottom: 10px; }
        .fx-slot {
            font-size: 9px; background: #222; padding: 3px; border-radius: 2px; text-align: center;
            cursor: pointer; border: 1px solid #333; color: #888;
        }
        .fx-slot:hover { border-color: #666; color: #fff; }
        .fx-slot.filled { border-color: var(--accent); color: var(--accent); background: rgba(6,182,212,0.1); }
        
        .fader-area { height: 120px; position: relative; display: flex; justify-content: center; }
        .vu-meter { position: absolute; right: 5px; top: 0; width: 4px; height: 100%; background: #222; border-radius: 2px; overflow: hidden; }
        .vu-val { width: 100%; height: 0%; background: linear-gradient(to top, var(--success), #fbbf24, var(--danger)); position: absolute; bottom: 0; transition: height 0.08s; }
        
        input[type=range].fader {
            -webkit-appearance: none; width: 100px; height: 20px; background: transparent;
            transform: rotate(-90deg) translateX(-40px); transform-origin: center;
        }
        input[type=range].fader::-webkit-slider-thumb {
            -webkit-appearance: none; height: 20px; width: 10px; background: #ddd;
            border-radius: 2px; cursor: ns-resize; box-shadow: 0 2px 5px rgba(0,0,0,0.5); margin-top: -8px;
        }
        input[type=range].fader::-webkit-slider-runnable-track { width: 100%; height: 4px; background: #000; border-radius: 2px; }

        /* --- FLOATING WINDOWS (PLUGINS) --- */
        .window-container { position: absolute; top:0; left:0; width:0; height:0; z-index: 200; }
        .plugin-window {
            position: absolute; width: 220px; background: rgba(20, 20, 25, 0.95);
            border: 1px solid var(--border); border-radius: 8px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5); backdrop-filter: blur(10px);
            display: flex; flex-direction: column; overflow: hidden;
            animation: popIn 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        .pw-header {
            background: #27272a; padding: 8px 10px; font-size: 11px; font-weight: bold;
            display: flex; justify-content: space-between; align-items: center; cursor: move;
            border-bottom: 1px solid #333; color: var(--accent);
        }
        .pw-close { cursor: pointer; color: #666; }
        .pw-close:hover { color: #fff; }
        
        .pw-body { padding: 15px; display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        
        .knob-wrapper { display: flex; flex-direction: column; align-items: center; gap: 5px; }
        .knob {
            width: 40px; height: 40px; border-radius: 50%; border: 2px solid #444; position: relative; cursor: ns-resize;
        }
        .knob::after {
            content: ''; position: absolute; top: 50%; left: 50%; width: 2px; height: 16px;
            background: var(--accent); transform-origin: top center; transform: translate(-50%, 0) rotate(var(--rot, 0deg));
        }
        .knob-label { font-size: 9px; color: #888; text-transform: uppercase; }

        /* --- LIBRARY MODAL --- */
        .modal-overlay {
            position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.7);
            z-index: 500; display: none; backdrop-filter: blur(4px); align-items: center; justify-content: center;
        }
        .lib-window {
            width: 800px; height: 600px; background: var(--bg-panel); border: 1px solid var(--border);
            border-radius: 12px; display: flex; flex-direction: column; box-shadow: 0 20px 50px rgba(0,0,0,0.8);
        }
        .lib-tabs { display: flex; border-bottom: 1px solid var(--border); padding: 10px; gap: 5px; }
        .lib-tab {
            padding: 8px 16px; background: transparent; color: #888; cursor: pointer;
            border-radius: 6px; font-size: 12px; font-weight: 600;
        }
        .lib-tab.active { background: var(--bg-lighter); color: #fff; }
        .lib-content { flex: 1; overflow-y: auto; padding: 10px; display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
        
        .sound-card {
            background: #222; padding: 15px; border-radius: 6px; cursor: pointer; border: 1px solid transparent;
            display: flex; flex-direction: column; gap: 5px;
        }
        .sound-card:hover { border-color: var(--accent); background: #2a2a2a; }
        .sc-name { font-weight: bold; font-size: 12px; color: #fff; }
        .sc-tag { font-size: 9px; color: #666; background: #111; padding: 2px 4px; border-radius: 2px; width: fit-content; }

    </style>
</head>
<body>

    <div id="loader">
        <div class="loader-brand">R0Y<span>PAD</span></div>
        <div class="loader-bar-container"><div class="loader-bar" id="lBar"></div></div>
        <div class="loader-msg" id="lMsg">Sistem başlatılıyor...</div>
        <div style="margin-top:20px; font-size:10px; color:#444;">ULTIMATE STUDIO EDITION v4.0</div>
    </div>

    <div class="window-container" id="windowLayer"></div>

    <div class="modal-overlay" id="libModal">
        <div class="lib-window">
            <div class="lib-tabs">
                <div class="lib-tab active" onclick="filterLib('kick')">KICKS (808s)</div>
                <div class="lib-tab" onclick="filterLib('snare')">SNARES</div>
                <div class="lib-tab" onclick="filterLib('hat')">HI-HATS & CYM</div>
                <div class="lib-tab" onclick="filterLib('synth')">SYNTHS & KEYS</div>
                <div style="flex:1"></div>
                <button class="btn btn-danger" onclick="document.getElementById('libModal').style.display='none'">KAPAT</button>
            </div>
            <div class="lib-content" id="libContent">
                </div>
        </div>
    </div>

    <header>
        <div class="logo">R0YC0LD <span>STUDIO</span></div>
        <div class="toolbar">
            <div class="btn">BPM: <input type="number" id="bpmIn" value="130" style="background:none; border:none; color:#fff; width:40px; text-align:center;"></div>
            <button class="btn" onclick="openLib()">+ ENSTRÜMAN EKLE</button>
            <div style="width:1px; background:#333; margin:0 5px;"></div>
            <button class="btn btn-primary" id="playBtn">▶ OYNAT</button>
            <button class="btn btn-danger" id="stopBtn">■ DUR</button>
        </div>
    </header>

    <div class="workspace">
        <div class="sequencer-area" id="seqArea">
            </div>
    </div>

    <div class="mixer-area" id="mixerArea">
        <div class="channel-strip master" style="margin-left: auto;">
            <div style="font-size:10px; font-weight:bold; text-align:center; color:var(--accent); margin-bottom:5px;">MASTER</div>
            <div class="fx-slot-container">
                <div class="fx-slot filled">LIMITER</div>
                <div class="fx-slot filled">COMPRESSOR</div>
            </div>
            <div class="fader-area">
                <div class="vu-meter"><div class="vu-val" id="masterVu"></div></div>
                <input type="range" class="fader" min="0" max="1.2" step="0.01" value="0.9" oninput="AudioEngine.setMasterVol(this.value)">
            </div>
        </div>
    </div>

<script>
    /**
     * R0YC0LD AUDIO CORE ENGINE v4
     * High Fidelity Web Audio Implementation
     */
    
    // --- 1. UTILITIES & GENERATORS ---
    const Utils = {
        rand: (min, max) => Math.random() * (max - min) + min,
        id: () => 'id_' + Math.random().toString(36).substr(2, 9)
    };

    // Procedural Sound Generator (Creating 200+ variations on the fly)
    const Library = [];
    const Categories = ['kick', 'snare', 'hat', 'synth'];
    
    // Generator Logic
    (() => {
        // Kicks & 808s
        for(let i=1; i<=30; i++) {
            Library.push({ id: `kick_${i}`, cat: 'kick', name: i<10 ? `R0Y 808 Pure ${i}` : `Hard Kick ${i}`, 
                params: { freq: 40 + (i*2), decay: i<10 ? 1.5 : 0.4, dist: i*2 } 
            });
        }
        // Snares
        for(let i=1; i<=30; i++) {
            Library.push({ id: `snare_${i}`, cat: 'snare', name: i<15 ? `Trap Snare ${i}` : `Rimshot ${i}`,
                params: { tone: 150 + (i*10), noiseRatio: 0.5 + (i*0.01), snap: 0.1 }
            });
        }
        // Hats
        for(let i=1; i<=30; i++) {
            Library.push({ id: `hat_${i}`, cat: 'hat', name: i%2==0 ? `Closed Hat ${i}` : `Open Hat ${i}`,
                params: { freq: 6000 + (i*200), len: i%2==0 ? 0.05 : 0.3 }
            });
        }
        // Synths
        const waves = ['sawtooth', 'square', 'triangle', 'sine'];
        for(let i=1; i<=30; i++) {
            Library.push({ id: `synth_${i}`, cat: 'synth', name: `R0Y Synth Pluck ${i}`,
                params: { wave: waves[i%4], filter: 500 + (i*100), attack: 0.01, release: 0.3 }
            });
        }
    })();

    // --- 2. AUDIO SYSTEM ---
    const AudioEngine = {
        ctx: null,
        masterGain: null,
        masterLimit: null,
        tracks: [],
        isPlaying: false,
        tempo: 130,
        currentStep: 0,
        nextTime: 0,
        timerID: null,

        init() {
            if(this.ctx) return;
            this.ctx = new (window.AudioContext || window.webkitAudioContext)();
            this.masterGain = this.ctx.createGain();
            this.masterLimit = this.ctx.createDynamicsCompressor();
            
            // Pro Mastering Chain
            this.masterLimit.threshold.value = -3;
            this.masterLimit.knee.value = 10;
            this.masterLimit.ratio.value = 12;
            this.masterLimit.attack.value = 0.005;
            this.masterLimit.release.value = 0.1;

            this.masterGain.gain.value = 0.9;
            this.masterGain.connect(this.masterLimit);
            this.masterLimit.connect(this.ctx.destination);
        },

        setMasterVol(v) { if(this.masterGain) this.masterGain.gain.value = v; },

        // Create Channel Strip
        createTrack(soundPreset) {
            const track = {
                id: Utils.id(),
                name: soundPreset.name,
                cat: soundPreset.cat,
                params: soundPreset.params,
                steps: new Array(16).fill(false),
                nodes: {
                    gain: this.ctx.createGain(),
                    pan: this.ctx.createStereoPanner(),
                    fxInput: this.ctx.createGain(), // FX Chain start
                    fxOutput: this.ctx.createGain() // FX Chain end
                },
                plugins: [], // Array of Plugin Objects
                vol: 0.8
            };

            // Wiring: FX Input -> FX Output -> Gain -> Pan -> Master
            // (Plugins will insert themselves between fxInput and fxOutput)
            track.nodes.fxInput.connect(track.nodes.fxOutput);
            track.nodes.fxOutput.connect(track.nodes.gain);
            track.nodes.gain.connect(track.nodes.pan);
            track.nodes.pan.connect(this.masterGain);

            track.nodes.gain.gain.value = 0.8;
            this.tracks.push(track);
            UI.renderTrack(track);
            UI.renderMixer(track);
        },

        // CORE SYNTHESIS
        trigger(track, time) {
            if(track.nodes.gain.gain.value < 0.01 || track.mute) return;

            const t = time;
            const p = track.params;
            const dest = track.nodes.fxInput; // Send audio to FX chain

            if(track.cat === 'kick') {
                const osc = this.ctx.createOscillator();
                const g = this.ctx.createGain();
                osc.connect(g); g.connect(dest);

                osc.frequency.setValueAtTime(p.freq, t);
                osc.frequency.exponentialRampToValueAtTime(10, t + p.decay);
                g.gain.setValueAtTime(1, t);
                g.gain.exponentialRampToValueAtTime(0.01, t + p.decay);

                // Simple Distortion for 808s
                if(p.dist > 0) {
                   // WaveShaper logic here simplified for performance
                }

                osc.start(t); osc.stop(t + p.decay);
            }
            else if(track.cat === 'snare') {
                // Tone
                const osc = this.ctx.createOscillator();
                osc.frequency.setValueAtTime(p.tone, t);
                const g = this.ctx.createGain();
                g.gain.setValueAtTime(0.5, t);
                g.gain.exponentialRampToValueAtTime(0.01, t + 0.1);
                osc.connect(g); g.connect(dest);
                osc.start(t); osc.stop(t+0.1);

                // Noise
                const noise = this.ctx.createBufferSource();
                const bSize = this.ctx.sampleRate * 0.2;
                const buf = this.ctx.createBuffer(1, bSize, this.ctx.sampleRate);
                const data = buf.getChannelData(0);
                for(let i=0;i<bSize;i++) data[i] = Math.random()*2-1;
                noise.buffer = buf;
                
                const f = this.ctx.createBiquadFilter();
                f.type = 'highpass'; f.frequency.value = 1000;
                const ng = this.ctx.createGain();
                ng.gain.setValueAtTime(1, t);
                ng.gain.exponentialRampToValueAtTime(0.01, t + 0.2);
                
                noise.connect(f); f.connect(ng); ng.connect(dest);
                noise.start(t);
            }
            else if(track.cat === 'hat') {
                const osc = this.ctx.createOscillator();
                osc.type = 'square';
                const f = this.ctx.createBiquadFilter();
                f.type = 'highpass'; f.frequency.value = p.freq;
                const g = this.ctx.createGain();
                
                osc.connect(f); f.connect(g); g.connect(dest);
                
                // Randomized velocity simulation
                const vel = 0.8 + Math.random()*0.2;
                g.gain.setValueAtTime(vel, t);
                g.gain.exponentialRampToValueAtTime(0.01, t + p.len);
                
                // Random pitch jitter
                osc.frequency.setValueAtTime(400 + Math.random()*500, t);

                osc.start(t); osc.stop(t + p.len);
            }
            else if(track.cat === 'synth') {
                const osc = this.ctx.createOscillator();
                osc.type = p.wave;
                const f = this.ctx.createBiquadFilter();
                f.type = 'lowpass'; f.frequency.setValueAtTime(p.filter, t);
                const g = this.ctx.createGain();
                
                osc.connect(f); f.connect(g); g.connect(dest);
                
                // Melody logic: Cycle through a minor chord
                const notes = [440, 523, 659, 523]; // Am
                const note = notes[this.currentStep % 4];
                osc.frequency.setValueAtTime(note, t);

                g.gain.setValueAtTime(0, t);
                g.gain.linearRampToValueAtTime(0.5, t + p.attack);
                g.gain.exponentialRampToValueAtTime(0.01, t + p.release);

                osc.start(t); osc.stop(t + p.release);
            }

            // UI Meter Animation
            UI.animateMeter(track.id, 0.8);
            UI.animateMeter('masterVu', 0.8);
        },

        // PLUGIN SYSTEM
        addPlugin(trackId, type) {
            const track = this.tracks.find(t => t.id === trackId);
            const pluginId = Utils.id();
            
            let node = null;
            let uiParams = []; // Defines knobs for UI

            if(type === 'R0Y-DELAY') {
                node = this.ctx.createDelay();
                node.delayTime.value = 0.3;
                const wet = this.ctx.createGain(); wet.gain.value = 0.5;
                // Simple routing wrapper for Wet/Dry
                // For simplicity in this demo, we insert directly:
                // Better implementation requires Dry/Wet mix node, but we'll chain insert
                uiParams = [
                    { name: 'TIME', min: 0, max: 1, param: node.delayTime },
                    { name: 'MIX', min: 0, max: 1, param: wet.gain } // Only works if parallel
                ];
                // Direct insert hack for demo:
                // Disconnect Chain -> Insert Plugin -> Reconnect
                // Real system is complex, simplifying:
                track.nodes.fxInput.disconnect();
                track.nodes.fxInput.connect(node);
                node.connect(track.nodes.fxOutput);
            } 
            else if(type === 'R0Y-DIST') {
                node = this.ctx.createWaveShaper();
                function makeDist(amount) {
                    let k = typeof amount === 'number' ? amount : 50, n_samples = 44100, curve = new Float32Array(n_samples), deg = Math.PI / 180, x;
                    for (let i = 0; i < n_samples; ++i ) { x = i * 2 / n_samples - 1; curve[i] = ( 3 + k ) * x * 20 * deg / ( Math.PI + k * Math.abs(x) ); }
                    return curve;
                }
                node.curve = makeDist(50);
                uiParams = [{ name: 'DRIVE', min: 0, max: 400, callback: (v) => node.curve = makeDist(v) }];
                
                track.nodes.fxInput.disconnect();
                track.nodes.fxInput.connect(node);
                node.connect(track.nodes.fxOutput);
            }
            // Add other types...

            track.plugins.push({ id: pluginId, type: type, node: node, params: uiParams });
            
            // Create UI Window
            UI.createPluginWindow(pluginId, type, uiParams);
            
            // Update Mixer Slot
            const slot = document.getElementById(`fx-list-${trackId}`);
            if(slot) {
                const div = document.createElement('div');
                div.className = 'fx-slot filled';
                div.innerText = type;
                div.onclick = () => {
                    const win = document.getElementById(`win-${pluginId}`);
                    if(win) win.style.display = 'flex';
                };
                slot.appendChild(div);
            }
        },

        // SCHEDULER
        schedule() {
            const lookahead = 25.0;
            const scheduleAhead = 0.1;

            const loop = () => {
                if(!this.isPlaying) return;
                
                while (this.nextTime < this.ctx.currentTime + scheduleAhead) {
                    const step = this.currentStep;
                    const time = this.nextTime;
                    
                    // Visual Sync
                    const drawTime = (time - this.ctx.currentTime) * 1000;
                    setTimeout(() => UI.highlightStep(step), drawTime);

                    // Trigger Audio
                    this.tracks.forEach(trk => {
                        if(trk.steps[step]) this.trigger(trk, time);
                    });

                    // Advance
                    const secondsPerBeat = 60.0 / this.tempo;
                    this.nextTime += 0.25 * secondsPerBeat;
                    this.currentStep = (this.currentStep + 1) % 16;
                }
                this.timerID = setTimeout(loop, lookahead);
            }
            loop();
        },

        play() {
            this.init();
            if(this.isPlaying) return;
            if(this.ctx.state === 'suspended') this.ctx.resume();
            
            this.isPlaying = true;
            this.currentStep = 0;
            this.nextTime = this.ctx.currentTime + 0.1;
            this.schedule();
        },

        stop() {
            this.isPlaying = false;
            clearTimeout(this.timerID);
            document.querySelectorAll('.step').forEach(s => s.classList.remove('playing'));
        }
    };

    // --- 3. UI CONTROLLER ---
    const UI = {
        renderTrack(track) {
            const area = document.getElementById('seqArea');
            const row = document.createElement('div');
            row.className = 'track-row';
            row.innerHTML = `
                <div class="track-header">
                    <div class="t-name">${track.name}</div>
                    <div class="t-cat">${track.cat}</div>
                </div>
            `;
            const grid = document.createElement('div');
            grid.className = 'step-grid';
            
            for(let i=0; i<16; i++) {
                const s = document.createElement('div');
                s.className = 'step';
                s.onclick = () => {
                    track.steps[i] = !track.steps[i];
                    s.classList.toggle('active');
                };
                grid.appendChild(s);
            }
            row.appendChild(grid);
            area.appendChild(row);
        },

        renderMixer(track) {
            const area = document.getElementById('mixerArea');
            // Insert before Master
            const master = area.lastElementChild;
            const strip = document.createElement('div');
            strip.className = 'channel-strip';
            strip.innerHTML = `
                <div style="font-size:9px; font-weight:bold; white-space:nowrap; overflow:hidden;">${track.name}</div>
                
                <div class="fx-slot-container" id="fx-list-${track.id}">
                    <div class="fx-slot" onclick="AudioEngine.addPlugin('${track.id}', 'R0Y-DIST')">+ DIST</div>
                    <div class="fx-slot" onclick="AudioEngine.addPlugin('${track.id}', 'R0Y-DELAY')">+ DELAY</div>
                </div>

                <div class="fader-area">
                    <div class="vu-meter"><div class="vu-val" id="vu-${track.id}"></div></div>
                    <input type="range" class="fader" min="0" max="1" step="0.01" value="0.8" 
                        oninput="AudioEngine.tracks.find(t=>t.id=='${track.id}').nodes.gain.gain.value=this.value">
                </div>
            `;
            area.insertBefore(strip, master);
        },

        createPluginWindow(pId, type, params) {
            const layer = document.getElementById('windowLayer');
            const win = document.createElement('div');
            win.className = 'plugin-window';
            win.id = `win-${pId}`;
            win.style.top = '100px'; win.style.left = '100px';
            
            let knobsHTML = '';
            params.forEach((p, idx) => {
                knobsHTML += `
                    <div class="knob-wrapper">
                        <div class="knob" id="knob-${pId}-${idx}"></div>
                        <div class="knob-label">${p.name}</div>
                    </div>
                `;
            });

            win.innerHTML = `
                <div class="pw-header" onmousedown="UI.dragWindow(event, '${pId}')">
                    ${type} <span class="pw-close" onclick="this.parentElement.parentElement.style.display='none'">X</span>
                </div>
                <div class="pw-body">${knobsHTML}</div>
            `;
            layer.appendChild(win);

            // Bind Knobs (Simple Logic)
            params.forEach((p, idx) => {
                const k = document.getElementById(`knob-${pId}-${idx}`);
                let val = 0.5; // default center
                let isDrag = false;
                let startY = 0;
                
                k.onmousedown = (e) => { isDrag = true; startY = e.clientY; }
                window.addEventListener('mousemove', (e) => {
                    if(!isDrag) return;
                    const delta = (startY - e.clientY) * 0.01;
                    val = Math.min(1, Math.max(0, val + delta));
                    k.style.setProperty('--rot', (val * 270 - 135) + 'deg');
                    
                    // Apply to audio param
                    const actualVal = p.min + val * (p.max - p.min);
                    if(p.param) p.param.value = actualVal;
                    if(p.callback) p.callback(actualVal);
                });
                window.addEventListener('mouseup', () => isDrag = false);
            });
        },

        dragWindow(e, id) {
            const win = document.getElementById(`win-${id}`);
            let shiftX = e.clientX - win.getBoundingClientRect().left;
            let shiftY = e.clientY - win.getBoundingClientRect().top;

            function moveAt(pageX, pageY) {
                win.style.left = pageX - shiftX + 'px';
                win.style.top = pageY - shiftY + 'px';
            }

            function onMouseMove(event) { moveAt(event.pageX, event.pageY); }

            document.addEventListener('mousemove', onMouseMove);
            document.onmouseup = function() {
                document.removeEventListener('mousemove', onMouseMove);
                document.onmouseup = null;
            };
        },

        highlightStep(step) {
            document.querySelectorAll('.step').forEach(s => s.classList.remove('playing'));
            document.querySelectorAll(`.step:nth-child(${step + 1})`).forEach(s => s.classList.add('playing'));
        },

        animateMeter(id, val) {
            const el = document.getElementById(id.includes('vu') ? id : `vu-${id}`);
            if(el) {
                el.style.height = (val * 100) + '%';
                setTimeout(() => el.style.height = '0%', 150);
            }
        }
    };

    // --- 4. APP LOGIC & EVENTS ---
    
    // Loader Logic
    const msgs = [
        "R0YC0LD beat'i ateşe veriyor...",
        "Pluginler crackleniyor... (şaka lisanslı)",
        "Stüdyo ışıkları ayarlanıyor...",
        "Komşular uyarılıyor...",
        "Autotune kalibre ediliyor...",
        "Sözleşmeler imzalanıyor...",
        "Grammy ödülü için yer açılıyor...",
        "R0YPAD Başlatılıyor..."
    ];
    
    let loadProgress = 0;
    const lBar = document.getElementById('lBar');
    const lMsg = document.getElementById('lMsg');
    
    const lInt = setInterval(() => {
        loadProgress += 0.5; // Slow loading (~15-20s total)
        lBar.style.width = loadProgress + '%';
        
        if(Math.floor(loadProgress) % 10 === 0) {
            lMsg.innerText = msgs[Math.floor(Math.random() * msgs.length)];
        }

        if(loadProgress >= 100) {
            clearInterval(lInt);
            document.getElementById('loader').style.opacity = 0;
            setTimeout(() => document.getElementById('loader').style.display = 'none', 500);
            
            // Init Default Kit
            AudioEngine.init();
            AudioEngine.createTrack(Library.find(x=>x.id==='kick_1'));
            AudioEngine.createTrack(Library.find(x=>x.id==='snare_1'));
            AudioEngine.createTrack(Library.find(x=>x.id==='hat_1'));
            AudioEngine.createTrack(Library.find(x=>x.id==='synth_1'));
        }
    }, 80); // 80ms * 200 ticks = 16 seconds

    // Library Filter
    window.openLib = () => document.getElementById('libModal').style.display = 'flex';
    window.filterLib = (cat) => {
        const cont = document.getElementById('libContent');
        cont.innerHTML = '';
        document.querySelectorAll('.lib-tab').forEach(t => t.classList.remove('active'));
        event.target.classList.add('active');

        Library.filter(x => x.cat === cat).forEach(item => {
            const el = document.createElement('div');
            el.className = 'sound-card';
            el.innerHTML = `<div class="sc-name">${item.name}</div><div class="sc-tag">${item.cat.toUpperCase()}</div>`;
            el.onclick = () => {
                AudioEngine.createTrack(item);
                document.getElementById('libModal').style.display = 'none';
            };
            cont.appendChild(el);
        });
    };
    // Init Library View
    window.filterLib('kick');

    // Controls
    document.getElementById('playBtn').onclick = () => AudioEngine.play();
    document.getElementById('stopBtn').onclick = () => AudioEngine.stop();
    document.getElementById('bpmIn').onchange = (e) => AudioEngine.tempo = parseInt(e.target.value);

</script>
</body>
</html>
