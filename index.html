<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>R0YPAD STUDIO | HYBRID CORE v9.0</title>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@400;600;800&family=Rajdhani:wght@600;700&display=swap" rel="stylesheet">
    <style>
        /* =========================================
           CORE THEME & VARIABLES
           ========================================= */
        :root {
            --bg-dark: #050505;
            --bg-panel: #0a0a0d;
            --bg-lighter: #111115;
            --primary: #00f0ff;    /* Cyber Blue */
            --secondary: #bd00ff;  /* Neon Purple */
            --accent: #ff0055;     /* Alert Red */
            --success: #00ff9d;    /* Signal Green */
            --text-main: #eee;
            --text-dim: #666;
            --border: #222;
            --glass: rgba(10, 10, 15, 0.95);
        }

        * { box-sizing: border-box; user-select: none; outline: none; }
        
        body {
            margin: 0; padding: 0;
            background: var(--bg-dark);
            color: var(--text-main);
            font-family: 'Inter', sans-serif;
            height: 100vh; width: 100vw;
            overflow: hidden;
            display: grid;
            grid-template-rows: 60px 1fr 320px; /* Header - Seq - Mixer */
        }

        /* SCROLLBARS */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #000; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--primary); }

        /* =========================================
           LOADING SCREEN
           ========================================= */
        #boot-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 9999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            font-family: 'JetBrains Mono', monospace;
        }
        .boot-logo { font-size: 4rem; font-weight: 800; letter-spacing: -2px; margin-bottom: 20px; text-shadow: 0 0 20px var(--primary); }
        .boot-logo span { color: var(--primary); }
        .boot-log { width: 400px; height: 150px; overflow: hidden; color: var(--text-dim); font-size: 11px; text-align: left; margin-bottom: 20px; border-left: 2px solid var(--border); padding-left: 10px; }
        .boot-btn {
            padding: 15px 40px; background: transparent; border: 1px solid var(--primary);
            color: var(--primary); font-size: 14px; font-weight: bold; cursor: pointer;
            transition: 0.3s; display: none; text-transform: uppercase; letter-spacing: 2px;
        }
        .boot-btn:hover { background: var(--primary); color: #000; box-shadow: 0 0 30px var(--primary); }

        /* =========================================
           HEADER & TOOLBAR
           ========================================= */
        header {
            background: var(--bg-panel); border-bottom: 1px solid var(--border);
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 20px; z-index: 100;
        }

        .brand { font-family: 'Rajdhani'; font-size: 24px; font-weight: 700; color: #fff; display: flex; align-items: center; gap: 10px; }
        .brand span { color: var(--primary); }
        
        .toolbar { display: flex; gap: 15px; align-items: center; }
        
        /* Buttons */
        .btn {
            padding: 8px 16px; border-radius: 4px; border: 1px solid var(--border);
            background: var(--bg-lighter); color: #ccc; font-size: 11px; font-weight: 700;
            cursor: pointer; transition: 0.2s; display: flex; align-items: center; gap: 6px;
        }
        .btn:hover { border-color: #555; color: #fff; }
        .btn:active { transform: translateY(1px); }
        
        .btn-primary { border-color: var(--primary); color: var(--primary); }
        .btn-primary:hover { background: rgba(0, 240, 255, 0.1); }
        
        .btn-ai { border-color: var(--secondary); color: var(--secondary); box-shadow: 0 0 10px rgba(189, 0, 255, 0.2); }
        .btn-ai:hover { background: var(--secondary); color: #fff; }

        .btn-play.active { background: var(--success); color: #000; border-color: var(--success); }
        .btn-stop:hover { border-color: var(--accent); color: var(--accent); }

        /* BPM Input */
        .bpm-wrap { display: flex; align-items: center; background: #000; border: 1px solid var(--border); padding: 4px 8px; border-radius: 4px; }
        .bpm-label { font-size: 9px; color: #666; margin-right: 5px; font-weight: bold; }
        input[type=number] { background: transparent; border: none; color: var(--primary); width: 40px; text-align: center; font-weight: bold; font-family: 'JetBrains Mono'; }

        /* =========================================
           SEQUENCER (WORKSPACE)
           ========================================= */
        .workspace {
            position: relative; background: #080808; overflow-y: auto;
            background-image: linear-gradient(rgba(255,255,255,0.02) 1px, transparent 1px);
            background-size: 100% 40px;
        }
        
        .track-list { padding: 20px; padding-bottom: 100px; }

        .track-row {
            display: flex; height: 50px; margin-bottom: 6px;
            background: rgba(255,255,255,0.02); border-left: 3px solid transparent;
            transition: 0.2s; border-radius: 0 4px 4px 0;
        }
        .track-row:hover { background: rgba(255,255,255,0.04); }
        .track-row.playing { background: rgba(255,255,255,0.06); }

        .track-header {
            width: 180px; padding: 0 15px; display: flex; flex-direction: column; justify-content: center;
            border-right: 1px solid var(--border); position: relative;
        }
        .th-name { font-size: 12px; font-weight: 700; color: #fff; }
        .th-cat { font-size: 9px; color: var(--primary); text-transform: uppercase; margin-top: 2px; }
        .th-controls { position: absolute; right: 10px; display: flex; gap: 5px; }
        .mini-btn { width: 16px; height: 16px; border-radius: 50%; border: 1px solid #333; background: #111; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 8px; color: #666; }
        .mini-btn:hover { color: #fff; border-color: #666; }
        .mini-btn.active { background: var(--accent); color: #fff; border-color: var(--accent); }

        .step-grid {
            flex: 1; display: grid; grid-template-columns: repeat(16, 1fr); gap: 2px; padding: 5px;
        }
        .step {
            background: #111; cursor: pointer; border-radius: 2px; transition: 0.1s;
        }
        .step:nth-child(4n+1) { background: #181818; }
        .step:hover { background: #222; }
        .step.active { background: var(--primary); box-shadow: 0 0 10px var(--primary); }
        .step.playhead { background: #fff !important; transform: scale(1.1); z-index: 10; }

        /* =========================================
           MIXER
           ========================================= */
        .mixer {
            background: var(--bg-panel); border-top: 1px solid var(--border);
            display: flex; padding: 15px; gap: 10px; overflow-x: auto;
            z-index: 50; box-shadow: 0 -10px 50px rgba(0,0,0,0.8);
        }

        .channel {
            width: 90px; flex-shrink: 0; background: var(--bg-lighter);
            border: 1px solid var(--border); border-radius: 4px;
            display: flex; flex-direction: column; padding: 8px;
            position: relative;
        }
        .channel.master { border-color: var(--secondary); background: #0e0a14; margin-left: auto; width: 110px; }

        .ch-name { font-size: 9px; text-align: center; color: #777; font-weight: bold; margin-bottom: 10px; text-transform: uppercase; white-space: nowrap; overflow: hidden; }
        
        /* FX BUTTONS */
        .fx-rack { display: flex; flex-direction: column; gap: 4px; margin-bottom: 10px; }
        .fx-btn {
            font-size: 8px; text-align: center; background: #000; color: #555;
            padding: 3px; border: 1px solid #222; cursor: pointer; border-radius: 2px;
        }
        .fx-btn:hover { color: #fff; border-color: #444; }
        .fx-btn.active { color: var(--primary); border-color: var(--primary); background: rgba(0, 240, 255, 0.1); }

        /* FADER */
        .fader-area { flex: 1; display: flex; justify-content: center; position: relative; }
        .meter { position: absolute; right: 5px; top: 0; bottom: 0; width: 4px; background: #000; border-radius: 2px; overflow: hidden; }
        .meter-val { position: absolute; bottom: 0; left: 0; width: 100%; height: 0%; background: linear-gradient(to top, var(--success), var(--accent)); opacity: 0.8; transition: height 0.05s; }
        
        input[type=range].vol {
            -webkit-appearance: none; width: 120px; height: 20px;
            background: transparent; transform: rotate(-90deg); margin-top: 50px; cursor: ns-resize;
        }
        input[type=range].vol::-webkit-slider-thumb {
            -webkit-appearance: none; width: 12px; height: 24px; background: #444; border: 1px solid #000; border-radius: 2px; box-shadow: 0 2px 5px #000;
        }
        .channel.master input[type=range].vol::-webkit-slider-thumb { background: var(--secondary); }

        /* =========================================
           MODALS & POPUPS
           ========================================= */
        .overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); backdrop-filter: blur(5px);
            z-index: 2000; display: none; align-items: center; justify-content: center;
        }

        .modal {
            background: var(--bg-lighter); border: 1px solid var(--border);
            border-radius: 8px; box-shadow: 0 20px 50px #000; width: 500px;
            animation: popUp 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            overflow: hidden;
        }
        @keyframes popUp { from{transform: scale(0.9); opacity:0;} to{transform: scale(1); opacity:1;} }

        .modal-head { padding: 15px; background: var(--bg-panel); border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .modal-title { font-weight: 700; font-size: 16px; color: #fff; }
        .close-btn { cursor: pointer; font-size: 20px; color: #666; }
        .close-btn:hover { color: var(--accent); }

        .modal-body { padding: 20px; }
        
        /* Library Grid */
        .lib-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .lib-item {
            padding: 15px; background: #000; border: 1px solid #222; color: #aaa;
            text-align: center; cursor: pointer; border-radius: 4px; font-size: 12px; font-weight: bold;
        }
        .lib-item:hover { border-color: var(--primary); color: #fff; background: #111; }
        .lib-item small { display: block; font-size: 9px; color: #555; margin-top: 5px; }

        /* AI Input */
        textarea.ai-in { width: 100%; height: 80px; background: #050505; border: 1px solid #333; color: #fff; padding: 10px; resize: none; border-radius: 4px; font-family: 'Inter'; }
        textarea.ai-in:focus { border-color: var(--secondary); }
        .ai-status { font-family: 'JetBrains Mono'; font-size: 10px; margin-top: 10px; color: var(--secondary); min-height: 15px; }

        /* FX Window (Floating) */
        .plugin-win {
            position: absolute; width: 220px; background: rgba(20,20,25,0.95);
            border: 1px solid #444; border-top: 2px solid var(--primary);
            border-radius: 4px; box-shadow: 0 10px 40px #000; display: none; z-index: 3000;
        }
        .pw-head { padding: 8px; background: #222; cursor: move; font-size: 10px; font-weight: bold; display: flex; justify-content: space-between; }
        .pw-body { padding: 15px; display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        
        .knob-wrap { text-align: center; }
        input[type=range].knob { width: 100%; cursor: pointer; }
        .knob-label { font-size: 9px; color: #888; margin-top: 2px; }

    </style>
</head>
<body>

    <div id="boot-screen">
        <div class="boot-logo">R0Y<span>PAD</span></div>
        <div class="boot-log" id="boot-log"></div>
        <button class="boot-btn" id="start-btn" onclick="System.init()">SİSTEMİ BAŞLAT</button>
    </div>

    <div class="overlay" id="modal-lib">
        <div class="modal">
            <div class="modal-head">
                <div class="modal-title">ENSTRÜMAN KÜTÜPHANESİ</div>
                <div class="close-btn" onclick="UI.toggleLib(false)">×</div>
            </div>
            <div class="modal-body">
                <div class="lib-grid" id="lib-content">
                    </div>
            </div>
        </div>
    </div>

    <div class="overlay" id="modal-ai">
        <div class="modal">
            <div class="modal-head">
                <div class="modal-title">YAPAY ZEKA <span style="color:var(--secondary)">MİMAR</span></div>
                <div class="close-btn" onclick="UI.toggleAI(false)">×</div>
            </div>
            <div class="modal-body">
                <p style="font-size:12px; color:#888; margin-bottom:10px;">
                    Nasıl bir parça istiyorsun? (Örn: "Hızlı agresif trap" veya "Sakin lo-fi")
                </p>
                <textarea class="ai-in" id="ai-prompt" placeholder="İsteğini buraya yaz..."></textarea>
                <button class="btn btn-ai" style="width:100%; justify-content:center; margin-top:10px; height:40px;" onclick="AI.generate()">
                    OLUŞTUR
                </button>
                <div class="ai-status" id="ai-log"></div>
            </div>
        </div>
    </div>

    <div id="plugin-layer"></div>

    <header>
        <div class="brand">R0Y<span>PAD</span> <div style="font-size:10px; background:#222; padding:2px 5px; border-radius:4px; margin-left:10px; color:#666;">v9.0 HYBRID</div></div>
        
        <div class="toolbar">
            <button class="btn btn-primary" onclick="UI.toggleLib(true)">+ KANAL EKLE</button>
            <button class="btn btn-ai" onclick="UI.toggleAI(true)">★ YAPAY ZEKA</button>
            
            <div style="width:1px; height:20px; background:#333;"></div>
            
            <div class="bpm-wrap">
                <span class="bpm-label">BPM</span>
                <input type="number" id="bpm-val" value="140" onchange="Engine.setBpm(this.value)">
            </div>
            
            <button class="btn" onclick="Engine.clear()">TEMİZLE</button>
            <button class="btn btn-play" id="play-btn" onclick="Engine.toggle()">▶ OYNAT</button>
            <button class="btn btn-stop" onclick="Engine.stop()">■ DUR</button>
        </div>
    </header>

    <div class="workspace">
        <div class="track-list" id="track-container">
            </div>
    </div>

    <div class="mixer" id="mixer-container">
        <div class="channel master">
            <div class="ch-name" style="color:var(--secondary)">MASTER</div>
            <div class="fx-rack">
                <div class="fx-btn active">COMP</div>
                <div class="fx-btn active">LIMIT</div>
                <div class="fx-btn" id="vis-toggle" onclick="UI.toggleVis()">VISUAL</div>
            </div>
            <div class="fader-area">
                <div class="meter"><div class="meter-val" id="vu-master"></div></div>
                <input type="range" class="vol" min="0" max="1.2" step="0.01" value="0.9" oninput="Engine.setMaster(this.value)">
            </div>
        </div>
    </div>
    
    <canvas id="vis-canvas" style="position:fixed; top:60px; left:0; width:100%; height:150px; pointer-events:none; opacity:0.5; display:none; mix-blend-mode:screen; z-index:90;"></canvas>

<script>
    /**
     * R0YPAD v9.0 HYBRID CORE ENGINE
     * ==============================
     * Contains:
     * 1. Audio Engine (Context, Scheduler, DSP)
     * 2. Synthesizer (Procedural Sound Gen)
     * 3. Effect Rack (Realtime Dist, Delay, Reverb)
     * 4. AI Composer (Logic & Theory)
     * 5. UI Controller
     */

    const Utils = {
        id: () => 't_' + Math.random().toString(36).substr(2, 9),
        wait: ms => new Promise(r => setTimeout(r, ms)),
        rand: (min, max) => Math.random() * (max - min) + min,
        // Distortion Curve
        distCurve: (amt) => {
            const k = amt, n = 44100, curve = new Float32Array(n), deg = Math.PI / 180;
            for (let i = 0; i < n; ++i) {
                const x = i * 2 / n - 1;
                curve[i] = (3 + k) * x * 20 * deg / (Math.PI + k * Math.abs(x));
            }
            return curve;
        },
        // Reverb Impulse
        impulse: (ctx, dur, decay) => {
            const L = ctx.sampleRate * dur, imp = ctx.createBuffer(2, L, ctx.sampleRate);
            for (let i = 0; i < L; i++) {
                let n = i / L, e = Math.pow(1 - n, decay);
                imp.getChannelData(0)[i] = (Math.random() * 2 - 1) * e;
                imp.getChannelData(1)[i] = (Math.random() * 2 - 1) * e;
            }
            return imp;
        }
    };

    // --- 1. AUDIO ENGINE ---
    const Engine = {
        ctx: null, master: null, limiter: null, analyser: null,
        tracks: [], isPlaying: false, step: 0, nextTime: 0, tempo: 140, timer: null,

        init() {
            if (this.ctx) return;
            const AC = window.AudioContext || window.webkitAudioContext;
            this.ctx = new AC();
            
            this.master = this.ctx.createGain();
            this.master.gain.value = 0.9;
            
            // Safety Limiter
            this.limiter = this.ctx.createDynamicsCompressor();
            this.limiter.threshold.value = -0.5; this.limiter.ratio.value = 20;
            
            // Visualizer Analyser
            this.analyser = this.ctx.createAnalyser();
            this.analyser.fftSize = 256;

            this.master.connect(this.limiter);
            this.limiter.connect(this.analyser);
            this.analyser.connect(this.ctx.destination);
            
            this.meterLoop();
        },

        toggle() {
            if(!this.ctx) this.init();
            if(this.ctx.state === 'suspended') this.ctx.resume();
            
            this.isPlaying = !this.isPlaying;
            const btn = document.getElementById('play-btn');
            
            if(this.isPlaying) {
                btn.classList.add('active'); btn.innerHTML = "|| DURAKLAT";
                this.step = 0; this.nextTime = this.ctx.currentTime + 0.1;
                this.scheduler();
            } else {
                btn.classList.remove('active'); btn.innerHTML = "▶ OYNAT";
                clearTimeout(this.timer);
            }
        },

        stop() {
            this.isPlaying = false; clearTimeout(this.timer);
            this.step = 0; UI.resetHead();
            const btn = document.getElementById('play-btn');
            btn.classList.remove('active'); btn.innerHTML = "▶ OYNAT";
        },

        scheduler() {
            while (this.nextTime < this.ctx.currentTime + 0.1) {
                this.playStep(this.step, this.nextTime);
                this.nextTime += 0.25 * (60.0 / this.tempo);
                this.step = (this.step + 1) % 16;
            }
            this.timer = setTimeout(() => this.scheduler(), 25);
        },

        playStep(s, t) {
            setTimeout(() => UI.drawHead(s), (t - this.ctx.currentTime) * 1000);
            
            this.tracks.forEach(tr => {
                if (tr.steps[s] && !tr.muted) {
                    tr.voice.trigger(t);
                    setTimeout(() => UI.pulse(tr.id), (t - this.ctx.currentTime) * 1000);
                }
            });
        },

        addTrack(cat, name, params = {}) {
            const t = new Track(this.ctx, this.master, cat, name, params);
            this.tracks.push(t);
            UI.renderTrack(t);
            UI.renderStrip(t);
            return t;
        },

        removeTrack(id) {
            const idx = this.tracks.findIndex(t => t.id === id);
            if(idx > -1) {
                this.tracks[idx].kill();
                this.tracks.splice(idx, 1);
                document.getElementById(`tr-${id}`).remove();
                document.getElementById(`ch-${id}`).remove();
                const win = document.getElementById(`win-${id}`);
                if(win) win.remove();
            }
        },

        clear() {
            this.tracks.forEach(t => t.steps.fill(false));
            document.querySelectorAll('.step.active').forEach(e => e.classList.remove('active'));
        },

        setBpm(v) { this.tempo = Math.max(40, Math.min(300, v)); },
        setMaster(v) { if(this.master) this.master.gain.value = v; },

        meterLoop() {
            if(this.isPlaying) {
                const arr = new Uint8Array(this.analyser.frequencyBinCount);
                this.analyser.getByteFrequencyData(arr);
                let sum = 0; for(let i=0;i<arr.length;i++) sum+=arr[i];
                const h = Math.min(100, (sum / arr.length) * 1.5);
                document.getElementById('vu-master').style.height = h + '%';
                
                // Canvas Visualizer
                if(document.getElementById('vis-canvas').style.display === 'block') {
                    const cvs = document.getElementById('vis-canvas');
                    const ctx = cvs.getContext('2d');
                    ctx.clearRect(0,0,cvs.width,cvs.height);
                    ctx.fillStyle = '#00f0ff';
                    const barW = cvs.width / arr.length;
                    for(let i=0; i<arr.length; i++) {
                        ctx.fillRect(i*barW, cvs.height - arr[i]/2, barW-1, arr[i]/2);
                    }
                }
            }
            requestAnimationFrame(() => this.meterLoop());
        }
    };

    // --- 2. TRACK & DSP ---
    class Track {
        constructor(ctx, dest, cat, name, params) {
            this.ctx = ctx; this.dest = dest; this.cat = cat;
            this.name = name; this.params = params;
            this.id = Utils.id();
            this.steps = Array(16).fill(false);
            this.muted = false;

            // Audio Graph: Synth -> FX (Dist->Delay->Reverb) -> Vol -> Master
            this.vol = ctx.createGain();
            this.vol.gain.value = 0.8;
            this.vol.connect(dest);

            // FX Nodes
            this.fxNodes = {
                dist: ctx.createWaveShaper(),
                delay: ctx.createDelay(),
                delayFb: ctx.createGain(),
                reverb: ctx.createConvolver(),
                reverbGain: ctx.createGain(),
                dry: ctx.createGain() // To mix dry signal with delay/reverb
            };

            // FX Setup defaults
            this.fxNodes.dist.curve = Utils.distCurve(0);
            this.fxNodes.dist.oversample = '4x';
            this.fxNodes.delay.delayTime.value = 0;
            this.fxNodes.delayFb.gain.value = 0;
            this.fxNodes.reverb.buffer = Utils.impulse(ctx, 2, 2);
            this.fxNodes.reverbGain.gain.value = 0;

            // Wiring: Input -> Dist -> (Dry + Delay + Reverb) -> Vol
            // *Input connection happens in VoiceEngine*
            // Here we setup the chain *after* the source
            
            // Dist Out
            this.fxNodes.dist.connect(this.fxNodes.dry);
            this.fxNodes.dist.connect(this.fxNodes.delay);
            this.fxNodes.dist.connect(this.fxNodes.reverb);

            // Delay Loop
            this.fxNodes.delay.connect(this.fxNodes.delayFb);
            this.fxNodes.delayFb.connect(this.fxNodes.delay);
            this.fxNodes.delay.connect(this.vol); // Wet Delay

            // Reverb
            this.fxNodes.reverb.connect(this.fxNodes.reverbGain);
            this.fxNodes.reverbGain.connect(this.vol); // Wet Reverb

            // Dry Signal
            this.fxNodes.dry.connect(this.vol);

            this.fxState = { dist:0, dTime:0, dFb:0, rev:0 };
            this.voice = new Synth(this);
        }

        updateFX(type, val) {
            if(type==='DIST') {
                this.fxState.dist = val;
                this.fxNodes.dist.curve = Utils.distCurve(val*4);
            } else if(type==='D_TIME') {
                this.fxState.dTime = val;
                this.fxNodes.delay.delayTime.value = (val/100) * 0.5;
            } else if(type==='D_FB') {
                this.fxState.dFb = val;
                this.fxNodes.delayFb.gain.value = (val/100) * 0.9;
            } else if(type==='REV') {
                this.fxState.rev = val;
                this.fxNodes.reverbGain.gain.value = (val/100);
            }
        }

        kill() { this.vol.disconnect(); }
    }

    // --- 3. SYNTHESIZER (PROCEDURAL) ---
    class Synth {
        constructor(track) { this.t = track; this.ctx = track.ctx; }
        
        trigger(time) {
            const dest = this.t.fxNodes.dist; // Connect to FX chain input
            const p = this.t.params;

            const osc = this.ctx.createOscillator();
            const g = this.ctx.createGain();
            
            if (this.t.cat === 'kick') {
                osc.frequency.setValueAtTime(p.freq || 100, time);
                osc.frequency.exponentialRampToValueAtTime(0.01, time + 0.5);
                g.gain.setValueAtTime(1, time);
                g.gain.exponentialRampToValueAtTime(0.001, time + 0.5);
                osc.connect(g); g.connect(dest);
                osc.start(time); osc.stop(time + 0.5);
            } 
            else if (this.t.cat === 'snare') {
                // Tone
                osc.type = 'triangle'; osc.frequency.setValueAtTime(200, time);
                const g2 = this.ctx.createGain();
                osc.connect(g2); g2.connect(dest);
                g2.gain.setValueAtTime(0.5, time); g2.gain.exponentialRampToValueAtTime(0.001, time+0.1);
                osc.start(time); osc.stop(time+0.1);
                // Noise
                const buf = this.ctx.createBuffer(1, 22050, 44100);
                const d = buf.getChannelData(0); for(let i=0;i<d.length;i++) d[i]=Math.random()*2-1;
                const src = this.ctx.createBufferSource(); src.buffer = buf;
                const f = this.ctx.createBiquadFilter(); f.type='highpass'; f.frequency.value=1000;
                const g3 = this.ctx.createGain();
                src.connect(f); f.connect(g3); g3.connect(dest);
                g3.gain.setValueAtTime(0.8, time); g3.gain.exponentialRampToValueAtTime(0.001, time+0.2);
                src.start(time);
            }
            else if (this.t.cat === 'hat') {
                // Metallic Noise
                const buf = this.ctx.createBuffer(1, 44100*0.05, 44100);
                const d = buf.getChannelData(0); for(let i=0;i<d.length;i++) d[i]=Math.random()*2-1;
                const src = this.ctx.createBufferSource(); src.buffer = buf;
                const f = this.ctx.createBiquadFilter(); f.type='highpass'; f.frequency.value=8000;
                src.connect(f); f.connect(g); g.connect(dest);
                g.gain.setValueAtTime(0.6, time); g.gain.exponentialRampToValueAtTime(0.001, time+0.05);
                src.start(time);
            }
            else { // Synth
                osc.type = p.wave || 'sawtooth';
                osc.frequency.value = p.freq || 440;
                const f = this.ctx.createBiquadFilter(); f.type='lowpass'; 
                f.frequency.setValueAtTime(p.cutoff||2000, time);
                f.frequency.linearRampToValueAtTime(100, time+0.4);
                osc.connect(f); f.connect(g); g.connect(dest);
                g.gain.setValueAtTime(0, time);
                g.gain.linearRampToValueAtTime(0.3, time+0.05);
                g.gain.exponentialRampToValueAtTime(0.001, time+0.5);
                osc.start(time); osc.stop(time+0.5);
            }
        }
    }

    // --- 4. AI COMPOSER ---
    const AI = {
        scales: {
            'minor': [0, 3, 7], // Basic triad
            'trap': [0, 1, 4, 5, 7, 8, 10], // Phrygian-ish
            'lofi': [0, 4, 7, 11] // Maj7
        },
        async generate() {
            const p = document.getElementById('ai-prompt').value.toLowerCase();
            const log = document.getElementById('ai-log');
            if(!p) { log.innerText = "Lütfen bir şeyler yazın..."; return; }
            
            log.innerText = "Analiz ediliyor...";
            await Utils.wait(500);

            // Logic
            let bpm = 130, genre = 'trap', tone = 'trap';
            if(p.includes('hızlı')) bpm = 145;
            if(p.includes('yavaş') || p.includes('lofi')) { bpm = 85; genre = 'lofi'; tone = 'lofi'; }
            if(p.includes('techno')) { bpm = 135; genre = 'techno'; }
            if(p.includes('drill')) { bpm = 142; genre = 'drill'; }

            Engine.clear();
            Engine.setBpm(bpm);
            document.getElementById('bpm-val').value = bpm;
            
            // Generate Tracks
            log.innerText = `Oluşturuluyor: ${genre.toUpperCase()} (${bpm} BPM)`;
            
            // Kick
            const kick = Engine.addTrack('kick', 'AI KICK', { freq: genre==='lofi'?50:60 });
            this.fill(kick, 'kick', genre);
            
            // Snare
            const snare = Engine.addTrack('snare', 'AI SNARE', {});
            this.fill(snare, 'snare', genre);
            
            // Hat
            const hat = Engine.addTrack('hat', 'AI HAT', {});
            this.fill(hat, 'hat', genre);
            
            // Melody (Random Note from Scale)
            const scale = this.scales[tone];
            const note = scale[Math.floor(Math.random()*scale.length)];
            const freq = 261.63 * Math.pow(2, note/12);
            const synth = Engine.addTrack('synth', 'AI MELODY', { 
                freq: freq, 
                wave: genre==='lofi'?'sine':'sawtooth',
                cutoff: genre==='techno'?800:3000
            });
            // Random FX for Melody
            if(genre==='trap') { synth.updateFX('DIST', 20); synth.updateFX('REV', 30); }
            if(genre==='lofi') { synth.updateFX('D_TIME', 50); synth.updateFX('D_FB', 40); }
            
            this.fill(synth, 'mel', genre);

            await Utils.wait(500);
            UI.toggleAI(false);
            Engine.toggle();
        },
        fill(track, type, genre) {
            for(let i=0; i<16; i++) {
                let hit = false;
                if(type==='kick') {
                    if(i===0) hit=true;
                    if(genre==='techno' && i%4===0) hit=true;
                    if(genre==='trap' && (i===10||i===14)) hit=Math.random()>0.4;
                } else if (type==='snare') {
                    if((genre==='trap'||genre==='drill') && i===8) hit=true;
                    if(genre==='techno' && (i===4||i===12)) hit=true;
                } else if (type==='hat') {
                    if(i%2===0) hit=true;
                    if(Math.random()>0.8) hit=true;
                } else {
                    if(Math.random()>0.7 && i%2===0) hit=true;
                }
                if(hit) {
                    track.steps[i] = true;
                    // UI Animation
                    setTimeout(()=>document.querySelector(`#s-${track.id}-${i}`).classList.add('active'), i*30);
                }
            }
        }
    };

    // --- 5. UI MANAGER ---
    const UI = {
        lib: [
            { cat:'kick', name:'808 Clean', p:{freq:50} },
            { cat:'kick', name:'Hard Kick', p:{freq:70} },
            { cat:'snare', name:'Trap Snare', p:{} },
            { cat:'snare', name:'Clap', p:{} },
            { cat:'hat', name:'Closed Hat', p:{} },
            { cat:'synth', name:'Saw Bass', p:{wave:'sawtooth', freq:110} },
            { cat:'synth', name:'Sine Pluck', p:{wave:'sine', freq:440} }
        ],
        init() {
            // Populate Lib
            const lc = document.getElementById('lib-content');
            this.lib.forEach(item => {
                const el = document.createElement('div');
                el.className = 'lib-item';
                el.innerHTML = `${item.name}<small>${item.cat.toUpperCase()}</small>`;
                el.onclick = () => { Engine.addTrack(item.cat, item.name, item.p); this.toggleLib(false); };
                lc.appendChild(el);
            });
            // Canvas resize
            const cvs = document.getElementById('vis-canvas');
            cvs.width = window.innerWidth; cvs.height = 150;
        },
        toggleLib(show) { document.getElementById('modal-lib').style.display = show?'flex':'none'; },
        toggleAI(show) { document.getElementById('modal-ai').style.display = show?'flex':'none'; },
        
        renderTrack(t) {
            const el = document.createElement('div');
            el.className = 'track-row'; el.id = `tr-${t.id}`;
            el.innerHTML = `
                <div class="track-header">
                    <div class="th-name">${t.name}</div>
                    <div class="th-cat">${t.cat}</div>
                    <div class="th-controls">
                        <div class="mini-btn" onclick="UI.toggleMute('${t.id}', this)">M</div>
                        <div class="mini-btn" style="color:var(--accent)" onclick="Engine.removeTrack('${t.id}')">X</div>
                    </div>
                </div>
                <div class="step-grid">
                    ${t.steps.map((_,i)=> `<div class="step" id="s-${t.id}-${i}" onclick="UI.togStep('${t.id}',${i},this)"></div>`).join('')}
                </div>
            `;
            document.getElementById('track-container').appendChild(el);
        },
        renderStrip(t) {
            const el = document.createElement('div');
            el.className = 'channel'; el.id = `ch-${t.id}`;
            el.innerHTML = `
                <div class="ch-name">${t.name}</div>
                <div class="fx-rack">
                    <div class="fx-btn" onclick="UI.openFX('${t.id}','DIST')">DIST</div>
                    <div class="fx-btn" onclick="UI.openFX('${t.id}','DELAY')">DELAY</div>
                    <div class="fx-btn" onclick="UI.openFX('${t.id}','REV')">REV</div>
                </div>
                <div class="fader-area">
                    <div class="meter"><div class="meter-val" id="vm-${t.id}"></div></div>
                    <input type="range" class="vol" min="0" max="1" step="0.01" value="0.8" 
                           oninput="Engine.tracks.find(x=>x.id=='${t.id}').vol.gain.value=this.value">
                </div>
            `;
            const c = document.getElementById('mixer-container');
            c.insertBefore(el, c.lastElementChild);
        },
        togStep(tid, idx, el) {
            const t = Engine.tracks.find(x=>x.id===tid);
            if(t) { t.steps[idx] = !t.steps[idx]; el.classList.toggle('active'); }
        },
        toggleMute(tid, el) {
            const t = Engine.tracks.find(x=>x.id===tid);
            if(t) { t.muted = !t.muted; el.classList.toggle('active'); }
        },
        drawHead(s) {
            document.querySelectorAll('.step.playhead').forEach(e=>e.classList.remove('playhead'));
            document.querySelectorAll(`.step:nth-child(${s+1})`).forEach(e=>e.classList.add('playhead'));
        },
        resetHead() { document.querySelectorAll('.step.playhead').forEach(e=>e.classList.remove('playhead')); },
        pulse(tid) {
            const m = document.getElementById(`vm-${tid}`);
            if(m) { m.style.height = (50+Math.random()*50)+'%'; setTimeout(()=>m.style.height='0%',100); }
        },
        
        // PLUGIN WINDOW LOGIC
        openFX(tid, type) {
            const pid = `win-${tid}`;
            if(document.getElementById(pid)) document.getElementById(pid).remove();
            
            const t = Engine.tracks.find(x=>x.id===tid);
            const win = document.createElement('div');
            win.className = 'plugin-win'; win.id = pid;
            win.style.top = '50%'; win.style.left = '50%';
            
            let knobs = '';
            if(type==='DIST') knobs = UI.mkKnob(tid,'DIST','DRIVE',t.fxState.dist,0,100);
            if(type==='DELAY') knobs = UI.mkKnob(tid,'D_TIME','TIME',t.fxState.dTime,0,100) + UI.mkKnob(tid,'D_FB','FDBK',t.fxState.dFb,0,100);
            if(type==='REV') knobs = UI.mkKnob(tid,'REV','MIX',t.fxState.rev,0,100);
            
            win.innerHTML = `
                <div class="pw-head" onmousedown="UI.drag(event,'${pid}')">
                    ${t.name} - ${type} <span onclick="this.parentElement.parentElement.remove()" style="cursor:pointer">X</span>
                </div>
                <div class="pw-body">${knobs}</div>
            `;
            document.getElementById('plugin-layer').appendChild(win);
        },
        mkKnob(tid, type, lbl, val, min, max) {
            return `
                <div class="knob-wrap">
                    <input type="range" class="knob" min="${min}" max="${max}" value="${val}"
                           oninput="Engine.tracks.find(x=>x.id=='${tid}').updateFX('${type}',this.value)">
                    <div class="knob-label">${lbl}</div>
                </div>
            `;
        },
        drag(e, id) {
            const el = document.getElementById(id);
            const x = e.clientX-el.offsetLeft, y = e.clientY-el.offsetTop;
            const mv = ev => { el.style.left=(ev.clientX-x)+'px'; el.style.top=(ev.clientY-y)+'px'; };
            document.addEventListener('mousemove',mv);
            document.onmouseup=()=>document.removeEventListener('mousemove',mv);
        },
        toggleVis() {
            const cvs = document.getElementById('vis-canvas');
            const tog = document.getElementById('vis-toggle');
            if(cvs.style.display==='none') {
                cvs.style.display='block'; tog.classList.add('active');
            } else {
                cvs.style.display='none'; tog.classList.remove('active');
            }
        }
    };

    // --- 6. SYSTEM START ---
    const System = {
        logs: ["CORE AUDIO INITIALIZED","DSP MODULES LOADED","AI NEURAL NET READY","SYSTEM OK"],
        async init() {
            const l = document.getElementById('boot-log');
            const b = document.getElementById('start-btn');
            for(let msg of this.logs) {
                l.innerHTML += `> ${msg}<br>`;
                await Utils.wait(300);
            }
            b.style.display = 'block';
        },
        init() { // Actually start
            Engine.init();
            UI.init();
            document.getElementById('boot-screen').style.opacity = 0;
            setTimeout(()=>document.getElementById('boot-screen').remove(),500);
        }
    };
    
    // Auto Boot Animation
    (async function bootAnim(){
        const l = document.getElementById('boot-log');
        for(let msg of ["KERNEL LOAD...", "MODULES CHECK...", "READY."]) {
            l.innerHTML += `> ${msg}<br>`; await Utils.wait(400);
        }
        document.getElementById('start-btn').style.display='block';
    })();

</script>
</body>
</html>
