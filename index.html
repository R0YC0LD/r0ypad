<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>R0YPAD STUDIO | MANUAL CORE v17.0</title>
    
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;800&family=Inter:wght@400;600;900&family=Rajdhani:wght@500;700&display=swap" rel="stylesheet">
    
    <style>
        /* [CORE CSS] */
        :root {
            --bg-void: #050505;
            --bg-panel: #0b0b0e;
            --bg-surface: #111114;
            --primary: #ffaa00; /* Gold/Orange Theme */
            --accent: #00f0ff;  /* Cyan Accent */
            --danger: #ff004c;
            --success: #00ff88;
            --border: #333;
            --glass: rgba(20,20,25,0.95);
            
            --h-head: 70px;
            --h-mix: 320px;
        }

        * { box-sizing: border-box; user-select: none; -webkit-user-drag: none; outline: none; }
        
        body {
            margin: 0; padding: 0; background: var(--bg-void); color: #eee;
            font-family: 'Inter', sans-serif; height: 100vh; width: 100vw;
            overflow: hidden; display: grid;
            grid-template-rows: var(--h-head) 1fr var(--h-mix);
            font-size: 11px;
        }

        /* SCROLLBAR */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #000; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--primary); }

        /* [BOOT SCREEN] */
        #boot-layer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 99999; display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            background: radial-gradient(circle, #111 0%, #000 90%);
        }
        .logo { font-family: 'Rajdhani'; font-size: 5rem; font-weight: 800; color: #fff; text-shadow: 0 0 30px var(--primary); margin-bottom: 20px; }
        .logo span { color: var(--primary); }
        .boot-btn {
            padding: 15px 50px; background: transparent; border: 2px solid var(--primary);
            color: var(--primary); font-family: 'Rajdhani'; font-size: 20px; font-weight: 700;
            cursor: pointer; transition: 0.3s; letter-spacing: 2px;
        }
        .boot-btn:hover { background: var(--primary); color: #000; box-shadow: 0 0 50px var(--primary); }

        /* [HEADER] */
        header {
            background: var(--bg-panel); border-bottom: 1px solid var(--border);
            padding: 0 25px; display: flex; align-items: center; justify-content: space-between;
            box-shadow: 0 10px 40px #000; z-index: 100;
        }
        .brand { font-family: 'Rajdhani'; font-size: 24px; font-weight: 700; color: #fff; }
        .brand span { color: var(--primary); }

        .toolbar { display: flex; gap: 10px; align-items: center; }
        
        .btn {
            height: 36px; padding: 0 20px; border-radius: 4px; font-weight: 700; font-size: 11px;
            cursor: pointer; border: 1px solid var(--border); background: var(--bg-surface); color: #ccc;
            display: flex; align-items: center; gap: 8px; transition: 0.2s;
        }
        .btn:hover { border-color: #666; color: #fff; }
        .btn-add { border-color: var(--primary); color: var(--primary); background: rgba(255, 170, 0, 0.05); }
        .btn-add:hover { background: var(--primary); color: #000; }

        .transport { display: flex; background: #000; padding: 5px; border-radius: 4px; border: 1px solid var(--border); gap: 5px; }
        .btn-tr { width: 45px; height: 32px; background: #151515; border: none; color: #666; cursor: pointer; border-radius: 2px; font-size: 14px; }
        .btn-tr:hover { color: #fff; background: #222; }
        .btn-play.active { background: var(--success); color: #000; }
        .btn-stop:hover { color: var(--danger); }

        .bpm-in { background: none; border: none; color: var(--accent); width: 40px; text-align: center; font-weight: bold; font-family: 'JetBrains Mono'; font-size: 14px; }

        /* [WORKSPACE] */
        .workspace {
            position: relative; background: #08080a; overflow-y: auto; padding: 20px;
            background-image: linear-gradient(#111 1px, transparent 1px); background-size: 100% 60px;
        }
        .track-list { display: flex; flex-direction: column; gap: 5px; padding-bottom: 150px; }

        .track-row {
            display: flex; height: 55px; background: var(--bg-surface);
            border: 1px solid var(--border); border-radius: 4px; transition: 0.1s;
        }
        .track-row:hover { background: #1a1a1d; border-color: #444; }
        .track-row.playing { border-left: 3px solid var(--primary); background: #1a1a1d; }

        .t-head {
            width: 220px; padding: 0 15px; border-right: 1px solid var(--border);
            display: flex; flex-direction: column; justify-content: center; position: relative;
        }
        .t-name { font-weight: 700; font-size: 12px; color: #fff; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .t-cat { font-size: 9px; color: var(--primary); text-transform: uppercase; margin-top: 3px; }
        
        .t-ctrls { position: absolute; right: 10px; display: flex; gap: 5px; }
        .mini-btn { width: 20px; height: 20px; background: #000; border: 1px solid #333; color: #666; display: flex; align-items: center; justify-content: center; cursor: pointer; border-radius: 3px; font-size: 9px; }
        .mini-btn:hover { color: #fff; border-color: #666; }
        .mini-btn.active { color: #000; background: var(--primary); border-color: var(--primary); }

        .t-grid { flex: 1; display: grid; grid-template-columns: repeat(16, 1fr); gap: 2px; padding: 5px; }
        .step { background: #000; border: 1px solid #222; border-radius: 2px; cursor: pointer; }
        .step:nth-child(4n+1) { background: #0c0c0e; }
        .step:hover { border-color: #555; }
        .step.active { background: var(--primary); box-shadow: 0 0 10px var(--primary); border-color: var(--primary); }
        .step.playhead { background: #fff !important; transform: scale(1.1); z-index: 10; }

        /* [MIXER] */
        .mixer {
            background: var(--bg-panel); border-top: 1px solid var(--border);
            padding: 15px; display: flex; gap: 8px; overflow-x: auto;
            box-shadow: 0 -10px 50px #000; z-index: 50;
        }

        .strip {
            width: 100px; height: 100%; background: var(--bg-surface);
            border: 1px solid var(--border); border-radius: 4px;
            display: flex; flex-direction: column; padding: 10px; flex-shrink: 0;
        }
        .strip.master { margin-left: auto; width: 130px; border-color: var(--accent); background: #050a0f; }

        .s-title { text-align: center; font-size: 9px; font-weight: bold; color: #666; margin-bottom: 10px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .master .s-title { color: var(--accent); }

        .fx-rack { display: flex; flex-direction: column; gap: 4px; margin-bottom: 10px; }
        .fx-btn {
            font-size: 9px; background: #050505; color: #555; padding: 5px; text-align: center;
            border: 1px solid #222; cursor: pointer; border-radius: 2px; transition: 0.2s;
        }
        .fx-btn:hover { color: #fff; border-color: #555; }
        .fx-btn.on { color: var(--primary); border-color: var(--primary); background: rgba(255, 170, 0, 0.1); }

        .fader-box { flex: 1; display: flex; justify-content: center; position: relative; background: #08080a; border-radius: 4px; border: 1px solid #1a1a1d; }
        .vu-meter { position: absolute; right: 8px; top: 10px; bottom: 10px; width: 4px; background: #000; border-radius: 2px; overflow: hidden; }
        .vu-val { position: absolute; bottom: 0; left: 0; width: 100%; height: 0%; background: linear-gradient(to top, var(--success), var(--primary), var(--danger)); opacity: 0.8; transition: height 0.05s; }

        input[type=range].vol {
            -webkit-appearance: none; width: 160px; height: 30px; background: transparent;
            transform: rotate(-90deg); margin-top: 80px; cursor: ns-resize;
        }
        input[type=range].vol::-webkit-slider-thumb {
            -webkit-appearance: none; width: 20px; height: 30px; background: #444;
            border: 1px solid #000; border-radius: 2px; box-shadow: 0 4px 10px #000; margin-top: -12px;
        }
        input[type=range].vol::-webkit-slider-runnable-track { width: 100%; height: 6px; background: #222; border-radius: 3px; }
        .master input[type=range].vol::-webkit-slider-thumb { background: var(--accent); }

        /* [MODALS] */
        .overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 5000; display: none;
            justify-content: center; align-items: center;
        }
        .modal { width: 900px; height: 700px; background: var(--bg-surface); border: 1px solid var(--border); border-top: 3px solid var(--primary); display: flex; flex-direction: column; box-shadow: 0 50px 150px #000; }
        
        .modal-head { padding: 15px 20px; background: var(--bg-panel); border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .modal-body { flex: 1; padding: 0; display: flex; overflow: hidden; }

        .lib-cats { width: 220px; background: #08080a; border-right: 1px solid var(--border); padding: 10px; display: flex; flex-direction: column; gap: 5px; }
        .cat-btn { text-align: left; padding: 10px; background: transparent; border: none; color: #888; cursor: pointer; font-weight: bold; font-size: 12px; border-radius: 4px; }
        .cat-btn:hover { color: #fff; background: #151515; }
        .cat-btn.active { color: var(--primary); background: rgba(255,170,0,0.1); border-left: 3px solid var(--primary); }

        .lib-content { flex: 1; padding: 20px; overflow-y: auto; }
        .lib-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 10px; }
        .lib-item { background: #111; padding: 15px; border: 1px solid #333; border-radius: 4px; cursor: pointer; transition: 0.2s; }
        .lib-item:hover { border-color: var(--primary); transform: translateY(-2px); background: #18181c; }
        .li-name { font-weight: bold; color: #eee; font-size: 12px; }
        .li-desc { font-size: 9px; color: #666; margin-top: 4px; }

        /* [PLUGIN WINDOW] */
        .plugin-win {
            position: absolute; width: 300px; background: rgba(15,15,20,0.98);
            border: 1px solid #444; border-top: 2px solid var(--primary);
            box-shadow: 0 30px 100px #000; z-index: 6000; display: none; flex-direction: column;
        }
        .pw-head { padding: 10px; background: #222; cursor: move; display: flex; justify-content: space-between; font-weight: bold; font-size: 11px; }
        .pw-body { padding: 20px; display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        
        .knob-wrap { text-align: center; }
        input[type=range].knob { width: 100%; cursor: pointer; accent-color: var(--primary); }
        .knob-lbl { font-size: 9px; color: #888; margin-top: 5px; }

    </style>
</head>
<body>

    <div id="boot-layer">
        <div class="logo">R0Y<span>PAD</span></div>
        <div style="font-family:'JetBrains Mono'; color:#666; margin-bottom:30px;">MANUAL CORE v17.0</div>
        <button class="boot-btn" onclick="Core.start()">SİSTEMİ BAŞLAT</button>
    </div>

    <div id="plugin-layer"></div>

    <div class="overlay" id="mod-lib">
        <div class="modal">
            <div class="modal-head">
                <span style="font-weight:bold; font-size:16px;">ENSTRÜMAN KÜTÜPHANESİ</span>
                <span style="cursor:pointer; font-size:20px;" onclick="UI.modal('mod-lib', false)">×</span>
            </div>
            <div class="modal-body">
                <div class="lib-cats" id="cat-list">
                    </div>
                <div class="lib-content">
                    <div class="lib-grid" id="lib-grid">
                        </div>
                </div>
            </div>
        </div>
    </div>

    <header>
        <div class="brand">R0Y<span>PAD</span></div>
        <div class="toolbar">
            <button class="btn btn-add" onclick="UI.modal('mod-lib', true)">+ KANAL EKLE</button>
            <button class="btn" onclick="Core.clear()">TEMİZLE</button>
            <div style="width:1px; height:20px; background:#333;"></div>
            <div class="transport">
                <span style="font-size:10px; color:#666; font-weight:bold; padding-left:5px;">BPM</span>
                <input type="number" class="bpm-in" id="bpm-val" value="130" onchange="Core.setBpm(this.value)">
                <button class="btn-tr" onclick="Core.stop()">■</button>
                <button class="btn-tr btn-play" id="btn-play" onclick="Core.toggle()">▶</button>
            </div>
        </div>
    </header>

    <div class="workspace">
        <div class="track-list" id="track-container">
            </div>
    </div>

    <div class="mixer" id="mixer-container">
        <div class="strip master">
            <div class="s-title">MASTER</div>
            <div class="fx-rack">
                <div class="fx-btn on">LIMITER</div>
                <div class="fx-btn on">COMP</div>
            </div>
            <div class="fader-box">
                <div class="vu-meter"><div class="vu-val" id="vu-master"></div></div>
                <input type="range" class="vol" min="0" max="1.2" step="0.01" value="0.9" oninput="Core.setMaster(this.value)">
            </div>
        </div>
    </div>

<script>
    /**
     * R0YPAD MANUAL CORE v17.0
     * ========================
     * Features:
     * - No AI. Pure manual creation.
     * - Massive procedural library (2500+ sounds).
     * - Categorized Library (Snare, Kick, HiHat, 808, Perc, Texture).
     * - Solid Audio Engine.
     */

    // --- 1. UTILS ---
    const Utils = {
        id: () => 't_' + Math.random().toString(36).substr(2, 9),
        rand: (min, max) => Math.random() * (max - min) + min,
        distCurve: (amount) => {
            const k = amount, n = 44100, curve = new Float32Array(n), deg = Math.PI / 180;
            for (let i = 0; i < n; ++i) {
                const x = i * 2 / n - 1;
                curve[i] = (3 + k) * x * 20 * deg / (Math.PI + k * Math.abs(x));
            }
            return curve;
        },
        impulse: (ctx, dur, decay) => {
            const L = ctx.sampleRate * dur, imp = ctx.createBuffer(2, L, ctx.sampleRate);
            for(let i=0; i<L; i++){
                const n=i/L, e=Math.pow(1-n, decay);
                imp.getChannelData(0)[i]=(Math.random()*2-1)*e;
                imp.getChannelData(1)[i]=(Math.random()*2-1)*e;
            }
            return imp;
        }
    };

    // --- 2. LIBRARY GENERATOR (MASSIVE) ---
    const Categories = {
        'SNARE': ['Acoustic', 'Trap', '808', 'Clap Layer', 'Rimshot', 'Lo-Fi', 'Chunky', 'Snappy', 'Bitcrush'],
        'CLAP': ['Dry', 'Wide', 'Reverb', 'Stadium', 'Crunchy'],
        'HIHAT': ['Closed', 'Open', 'Tight', 'Trap', 'Shaker', 'Metallic'],
        'KICK': ['808', 'Hard Punch', 'Distorted', 'Soft Boom', 'Trap', 'Sub Heavy'],
        '808': ['Clean', 'Distorted', 'Glide', 'Long', 'Punchy'],
        'PERC': ['Cowbell', 'Woodblock', 'Bongo', 'Triangle', 'Snap', 'Impact FX'],
        'TEXTURE': ['Vinyl Crackle', 'Room Noise', 'Tape Hiss', 'Atmosphere']
    };

    const Library = {
        data: [],
        init() {
            // Generate Procedural Presets
            Object.keys(Categories).forEach(cat => {
                Categories[cat].forEach(sub => {
                    // Generate 50 variations for each sub-type to simulate "Thousands"
                    for(let i=1; i<=50; i++) {
                        this.data.push({
                            cat: cat,
                            sub: sub,
                            name: `${sub} ${cat} ${i}`,
                            params: this.genParams(cat, sub, i)
                        });
                    }
                });
            });
            UI.initLibrary();
        },
        genParams(cat, sub, seed) {
            // Parameter Logic based on Category
            const p = { freq: 0, decay: 0, type: 'sine', noise: false, dist: 0 };
            
            if(cat === 'KICK') {
                p.freq = Utils.rand(40, 80); 
                p.decay = Utils.rand(0.3, 0.8);
                if(sub.includes('Distorted')) p.dist = 30;
                if(sub.includes('Hard')) p.freq += 20;
            } 
            else if(cat === 'SNARE' || cat === 'CLAP') {
                p.freq = Utils.rand(150, 300);
                p.decay = Utils.rand(0.1, 0.3);
                p.noise = true; // Snares need noise
                p.type = 'triangle';
                if(sub.includes('808')) p.type = 'sine';
            }
            else if(cat === 'HIHAT') {
                p.freq = Utils.rand(5000, 12000);
                p.decay = sub.includes('Open') ? 0.3 : 0.05;
                p.noise = true;
                p.type = 'square';
            }
            else if(cat === '808') {
                p.freq = Utils.rand(30, 60);
                p.decay = sub.includes('Long') ? 1.5 : 0.6;
                p.type = sub.includes('Distorted') ? 'sawtooth' : 'sine';
                if(sub.includes('Glide')) p.glide = true;
            }
            else if(cat === 'TEXTURE') {
                p.texture = true; // Infinite loop mode
                p.noiseType = sub.includes('Vinyl') ? 'pink' : 'white';
            }
            else { // Perc
                p.freq = Utils.rand(300, 800);
                p.decay = 0.1;
                p.type = 'square';
            }
            return p;
        },
        get(cat) {
            return this.data.filter(x => x.cat === cat);
        }
    };

    // --- 3. AUDIO ENGINE ---
    const Core = {
        ctx: null, master: null, limiter: null, analyser: null,
        tracks: [], isPlaying: false, step: 0, nextTime: 0, tempo: 130, timer: null,

        start() {
            try {
                const AC = window.AudioContext || window.webkitAudioContext;
                this.ctx = new AC();
                this.master = this.ctx.createGain(); this.master.gain.value = 0.9;
                
                this.limiter = this.ctx.createDynamicsCompressor();
                this.limiter.threshold.value = -1.0; this.limiter.ratio.value = 20;

                this.analyser = this.ctx.createAnalyser();
                this.analyser.fftSize = 256;

                this.master.connect(this.limiter);
                this.limiter.connect(this.analyser);
                this.analyser.connect(this.ctx.destination);

                document.getElementById('boot-layer').style.display = 'none';
                Library.init();
                
                // Demo Tracks
                this.addTrack(Library.data.find(x => x.name.includes('Hard Punch Kick')));
                this.addTrack(Library.data.find(x => x.name.includes('Trap Snare')));
                this.addTrack(Library.data.find(x => x.name.includes('Closed')));
                
                this.loop();
            } catch(e) { alert("Audio Error: " + e); }
        },

        toggle() {
            if(!this.ctx) return;
            if(this.ctx.state === 'suspended') this.ctx.resume();
            this.isPlaying = !this.isPlaying;
            const btn = document.getElementById('btn-play');
            
            if(this.isPlaying) {
                btn.classList.add('active'); btn.innerHTML = "||";
                this.step = 0; this.nextTime = this.ctx.currentTime + 0.1;
                this.scheduler();
            } else {
                btn.classList.remove('active'); btn.innerHTML = "▶";
                clearTimeout(this.timer);
            }
        },

        stop() {
            this.isPlaying = false; clearTimeout(this.timer);
            this.step = 0; UI.resetHeads();
            document.getElementById('btn-play').classList.remove('active');
            document.getElementById('btn-play').innerHTML = "▶";
        },

        scheduler() {
            while (this.nextTime < this.ctx.currentTime + 0.1) {
                this.playStep(this.step, this.nextTime);
                this.nextTime += 0.25 * (60.0 / this.tempo);
                this.step = (this.step + 1) % 16;
            }
            this.timer = setTimeout(() => this.scheduler(), 25);
        },

        playStep(s, t) {
            const dt = (t - this.ctx.currentTime) * 1000;
            setTimeout(() => UI.drawHead(s), Math.max(0, dt));
            this.tracks.forEach(tr => {
                if(tr.steps[s] && !tr.muted) {
                    tr.voice.trigger(t);
                    setTimeout(() => UI.pulse(tr.id), Math.max(0, dt));
                }
            });
        },

        addTrack(data) {
            const t = new Track(this.ctx, this.master, data);
            this.tracks.push(t);
            UI.renderTrack(t);
            UI.renderStrip(t);
        },

        removeTrack(id) {
            const idx = this.tracks.findIndex(t => t.id === id);
            if(idx > -1) {
                this.tracks[idx].kill();
                this.tracks.splice(idx, 1);
                UI.removeUI(id);
            }
        },

        clear() { this.tracks.forEach(t => t.steps.fill(false)); UI.refreshGrid(); },
        setBpm(v) { this.tempo = Utils.rand(40,300); this.tempo = parseInt(v); },
        setMaster(v) { if(this.master) this.master.gain.value = v; },

        loop() {
            if(this.isPlaying) {
                const arr = new Uint8Array(this.analyser.frequencyBinCount);
                this.analyser.getByteFrequencyData(arr);
                let s=0; for(let i=0;i<arr.length;i++) s+=arr[i];
                const h = Math.min(100, (s/arr.length)*1.5);
                document.getElementById('vu-master').style.height = h + '%';
            }
            requestAnimationFrame(() => this.loop());
        }
    };

    // --- 4. TRACK & SYNTH ---
    class Track {
        constructor(ctx, dest, data) {
            this.ctx = ctx; this.data = data; this.id = Utils.id();
            this.steps = Array(16).fill(false); this.muted = false;

            this.vol = ctx.createGain(); this.vol.gain.value = 0.8;
            this.vol.connect(dest);

            this.fx = {
                dist: ctx.createWaveShaper(),
                delay: ctx.createDelay(), dFb: ctx.createGain(),
                rev: ctx.createConvolver(), rGain: ctx.createGain(),
                dry: ctx.createGain()
            };

            this.fx.dist.curve = Utils.distCurve(0); this.fx.dist.oversample = '4x';
            this.fx.delay.delayTime.value = 0; this.fx.dFb.gain.value = 0;
            this.fx.delay.connect(this.fx.dFb); this.fx.dFb.connect(this.fx.delay);
            this.fx.rev.buffer = Utils.impulse(ctx, 2, 2); this.fx.rGain.gain.value = 0;

            // Chain: Input -> Dist -> (Dry + Delay + Rev) -> Vol
            this.input = this.fx.dist;
            this.fx.dist.connect(this.fx.dry); this.fx.dist.connect(this.fx.delay); this.fx.dist.connect(this.fx.rev);
            this.fx.dry.connect(this.vol); this.fx.delay.connect(this.vol); this.fx.rev.connect(this.fx.rGain);
            this.fx.rGain.connect(this.vol);

            this.params = { dist:0, delay:0, rev:0 };
            
            // Texture Handling (Auto Play Loop)
            if(this.data.params.texture) {
                this.voice = new TextureVoice(this);
                this.voice.start(); // Always on
            } else {
                this.voice = new SynthVoice(this);
            }
        }

        updateFX(type, val) {
            const v = parseFloat(val);
            if(type==='DIST') { this.params.dist=v; this.fx.dist.curve = Utils.distCurve(v*4); }
            if(type==='DELAY') { this.params.delay=v; this.fx.delay.delayTime.value=(v/100)*0.5; this.fx.dFb.gain.value=(v/100)*0.8; }
            if(type==='REV') { this.params.rev=v; this.fx.rGain.gain.value=(v/100); }
        }

        kill() { this.vol.disconnect(); }
    }

    class SynthVoice {
        constructor(track) { this.t = track; this.ctx = track.ctx; }
        trigger(time) {
            const dest = this.t.input;
            const p = this.t.data.params;
            const c = this.ctx;

            // Tone Osc
            const osc = c.createOscillator();
            const gain = c.createGain();
            osc.type = p.type || 'sine';
            osc.frequency.setValueAtTime(p.freq, time);
            
            // Envelope
            gain.gain.setValueAtTime(p.dist ? 0.5 : 1, time); // Lower gain for dist sounds
            gain.gain.exponentialRampToValueAtTime(0.001, time + p.decay);
            
            // Kick Sweep
            if(this.t.data.cat === 'KICK') {
                osc.frequency.exponentialRampToValueAtTime(10, time + p.decay);
            }

            osc.connect(gain); gain.connect(dest);
            osc.start(time); osc.stop(time + p.decay + 0.1);

            // Noise Layer (Snare/Hat)
            if(p.noise) {
                const b = c.createBuffer(1, c.sampleRate * p.decay, c.sampleRate);
                const d = b.getChannelData(0); for(let i=0; i<d.length; i++) d[i] = Math.random()*2-1;
                const n = c.createBufferSource(); n.buffer = b;
                const nf = c.createBiquadFilter(); nf.type = 'highpass'; nf.frequency.value = 1000;
                const ng = c.createGain();
                
                n.connect(nf); nf.connect(ng); ng.connect(dest);
                ng.gain.setValueAtTime(this.t.data.cat==='HIHAT'?0.4:0.8, time);
                ng.gain.exponentialRampToValueAtTime(0.001, time + p.decay);
                n.start(time);
            }
        }
    }

    class TextureVoice {
        constructor(track) { this.t = track; this.ctx = track.ctx; }
        start() {
            const c = this.ctx;
            const bufSize = c.sampleRate * 2;
            const buf = c.createBuffer(1, bufSize, c.sampleRate);
            const data = buf.getChannelData(0);
            
            // Pink Noise Generation for Texture
            let b0, b1, b2, b3, b4, b5, b6;
            b0 = b1 = b2 = b3 = b4 = b5 = b6 = 0.0;
            for (let i = 0; i < bufSize; i++) {
                let white = Math.random() * 2 - 1;
                b0 = 0.99886 * b0 + white * 0.0555179;
                b1 = 0.99332 * b1 + white * 0.0750759;
                b2 = 0.96900 * b2 + white * 0.1538520;
                b3 = 0.86650 * b3 + white * 0.3104856;
                b4 = 0.55000 * b4 + white * 0.5329522;
                b5 = -0.7616 * b5 - white * 0.0168980;
                data[i] = b0 + b1 + b2 + b3 + b4 + b5 + b6 + white * 0.5362;
                data[i] *= 0.11; // gain
                b6 = white * 0.115926;
            }

            const src = c.createBufferSource();
            src.buffer = buf;
            src.loop = true;
            
            const filter = c.createBiquadFilter(); // Filter for crackle feel
            filter.type = 'bandpass'; filter.frequency.value = 1000;

            const g = c.createGain(); g.gain.value = 0; // Controlled by sequencer/mixer
            
            src.connect(filter); filter.connect(g); g.connect(this.t.input);
            src.start();
            this.gainNode = g;
        }
        trigger(time) {
            // Texture is continuous, but we can modulate it or just let it run if steps are active
            // Here we assume if added, it plays. Volume controlled by mixer.
        }
    }

    // --- 5. UI MANAGER ---
    const UI = {
        modal(id, show) { document.getElementById(id).style.display = show?'flex':'none'; },
        
        initLibrary() {
            const cats = document.getElementById('cat-list');
            Object.keys(Categories).forEach(cat => {
                const btn = document.createElement('button');
                btn.className = 'cat-btn'; btn.innerText = cat;
                btn.onclick = () => {
                    document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    this.renderLibContent(cat);
                };
                cats.appendChild(btn);
            });
            // Default load
            this.renderLibContent('SNARE');
            document.querySelector('.cat-btn').classList.add('active');
        },

        renderLibContent(cat) {
            const grid = document.getElementById('lib-grid');
            grid.innerHTML = '';
            const items = Library.get(cat);
            // Virtual render limit 100
            items.slice(0, 100).forEach(item => {
                const el = document.createElement('div');
                el.className = 'lib-item';
                el.innerHTML = `<div class="li-name">${item.name}</div><div class="li-desc">${item.sub}</div>`;
                el.onclick = () => { Core.addTrack(item); this.modal('mod-lib', false); };
                grid.appendChild(el);
            });
        },

        renderTrack(t) {
            const el = document.createElement('div');
            el.className = 'track-row'; el.id = `tr-${t.id}`;
            el.innerHTML = `
                <div class="t-head">
                    <div>
                        <div class="t-name">${t.data.name}</div>
                        <div class="t-cat">${t.data.cat} - ${t.data.sub}</div>
                    </div>
                    <div class="t-ctrls">
                        <div class="mini-btn" onclick="UI.mute('${t.id}',this)">M</div>
                        <div class="mini-btn" style="color:var(--danger)" onclick="Core.removeTrack('${t.id}')">X</div>
                    </div>
                </div>
                <div class="t-grid">
                    ${t.steps.map((_,i) => `<div class="step" id="s-${t.id}-${i}" onclick="UI.tog('${t.id}',${i},this)"></div>`).join('')}
                </div>
            `;
            document.getElementById('track-container').appendChild(el);
        },

        renderStrip(t) {
            const el = document.createElement('div');
            el.className = 'strip'; el.id = `ch-${t.id}`;
            el.innerHTML = `
                <div class="s-title">${t.data.name}</div>
                <div class="fx-rack">
                    <div class="fx-btn" onclick="UI.fx('${t.id}','DIST')">DIST</div>
                    <div class="fx-btn" onclick="UI.fx('${t.id}','DELAY')">DELAY</div>
                    <div class="fx-btn" onclick="UI.fx('${t.id}','REV')">REV</div>
                </div>
                <div class="fader-box">
                    <div class="vu-meter"><div class="vu-val" id="vm-${t.id}"></div></div>
                    <input type="range" class="vol" min="0" max="1" step="0.01" value="0.8" oninput="Core.tracks.find(x=>x.id=='${t.id}').vol.gain.value=this.value">
                </div>
            `;
            const c = document.getElementById('mixer-container');
            c.insertBefore(el, c.querySelector('.master'));
        },

        removeUI(id) { document.getElementById(`tr-${id}`).remove(); document.getElementById(`ch-${id}`).remove(); },
        tog(tid, i, el) { const t=Core.tracks.find(x=>x.id===tid); if(t){ t.steps[i]=!t.steps[i]; el.classList.toggle('active'); } },
        mute(tid, el) { const t=Core.tracks.find(x=>x.id===tid); if(t){ t.muted=!t.muted; el.classList.toggle('active'); } },
        
        drawHead(s) { document.querySelectorAll('.playhead').forEach(e=>e.classList.remove('playhead')); document.querySelectorAll(`.step:nth-child(${s+1})`).forEach(e=>e.classList.add('playhead')); },
        resetHeads() { document.querySelectorAll('.playhead').forEach(e=>e.classList.remove('playhead')); },
        refreshGrid() { document.querySelectorAll('.step.active').forEach(e=>e.classList.remove('active')); },
        pulse(id) { const m=document.getElementById(`vm-${id}`); if(m){ m.style.height=(50+Math.random()*50)+'%'; setTimeout(()=>m.style.height='0%',100); } },

        fx(tid, type) {
            const pid = `win-${tid}`;
            if(document.getElementById(pid)) document.getElementById(pid).remove();
            
            const t = Core.tracks.find(x=>x.id===tid);
            const win = document.createElement('div');
            win.className = 'plugin-win'; win.id = pid;
            win.style.left='40%'; win.style.top='30%';
            
            let h = '';
            if(type==='DIST') h = UI.knob(tid,'DIST','DRIVE',t.params.dist,0,100);
            if(type==='DELAY') h = UI.knob(tid,'DELAY','TIME',t.params.delay,0,100);
            if(type==='REV') h = UI.knob(tid,'REV','MIX',t.params.rev,0,100);

            win.innerHTML = `
                <div class="pw-head">
                    <span>${t.data.name} - ${type}</span>
                    <span style="cursor:pointer" onclick="this.parentElement.parentElement.remove()">✕</span>
                </div>
                <div class="pw-body">${h}</div>
            `;
            document.getElementById('plugin-layer').appendChild(win);
            win.style.display = 'flex';
            
            // Drag Logic
            let isDown=false, offset=[0,0];
            const head = win.querySelector('.pw-head');
            head.addEventListener('mousedown', (e) => { isDown=true; offset=[win.offsetLeft-e.clientX, win.offsetTop-e.clientY]; }, true);
            document.addEventListener('mouseup', () => { isDown=false; }, true);
            document.addEventListener('mousemove', (e) => { if(isDown){ win.style.left=(e.clientX+offset[0])+'px'; win.style.top=(e.clientY+offset[1])+'px'; } }, true);
        },
        knob(tid, type, lbl, val, min, max) {
            return `
                <div class="knob-wrap">
                    <input type="range" class="knob" min="${min}" max="${max}" value="${val}"
                           oninput="Core.tracks.find(x=>x.id=='${tid}').updateFX('${type}',this.value)">
                    <div class="knob-lbl">${lbl}</div>
                </div>
            `;
        }
    };

</script>
</body>
</html>
