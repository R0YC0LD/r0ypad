<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>R0YPAD | Professional Web Audio Workstation</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Roboto+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-body: #121214;
            --bg-panel: #1e1e24;
            --bg-darker: #0d0d10;
            --primary: #00ff9d; /* R0Y Green */
            --secondary: #bd00ff; /* Synthwave Purple */
            --danger: #ff2a6d;
            --text-main: #e1e1e6;
            --text-muted: #a8a8b3;
            --knob-size: 40px;
        }

        * { box-sizing: border-box; user-select: none; scrollbar-width: thin; }
        
        body {
            margin: 0;
            background-color: var(--bg-body);
            color: var(--text-main);
            font-family: 'Roboto Mono', monospace;
            height: 100vh;
            overflow: hidden;
            display: grid;
            grid-template-rows: 60px 1fr 280px; /* Header, Sequencer, Mixer */
        }

        /* --- 1. HEADER --- */
        header {
            background: var(--bg-darker);
            border-bottom: 2px solid var(--primary);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            box-shadow: 0 0 20px rgba(0, 255, 157, 0.1);
            z-index: 10;
        }

        .logo {
            font-family: 'Orbitron', sans-serif;
            font-size: 24px;
            font-weight: 900;
            letter-spacing: 2px;
            color: var(--text-main);
        }
        .logo span { color: var(--primary); }

        .transport {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .btn {
            background: #2a2a35;
            border: 1px solid #3a3a45;
            color: var(--text-main);
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-family: inherit;
            font-weight: bold;
            transition: all 0.2s;
            text-transform: uppercase;
            font-size: 12px;
        }
        .btn:hover { background: #3a3a45; border-color: var(--text-muted); }
        .btn:active { transform: translateY(1px); }
        
        .btn.play { border-color: var(--primary); color: var(--primary); }
        .btn.play.active { background: var(--primary); color: #000; box-shadow: 0 0 15px var(--primary); }
        .btn.stop { border-color: var(--danger); color: var(--danger); }
        
        .lcd-display {
            background: #000;
            color: var(--primary);
            padding: 5px 10px;
            border-radius: 4px;
            border: 1px solid #333;
            font-family: 'Orbitron', monospace;
            min-width: 60px;
            text-align: center;
        }

        /* --- 2. SEQUENCER RACK (Middle) --- */
        .rack-container {
            padding: 20px;
            overflow-y: auto;
            background: radial-gradient(circle at center, #1a1a20 0%, #121214 100%);
        }

        .track-row {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            background: var(--bg-panel);
            padding: 10px;
            border-radius: 6px;
            border-left: 4px solid #333;
            transition: border-color 0.2s;
        }
        .track-row:hover { border-left-color: var(--text-muted); }
        .track-row.selected { border-left-color: var(--primary); background: #25252e; }

        .track-info {
            width: 120px;
            font-weight: bold;
            font-size: 14px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        .track-type { font-size: 10px; color: var(--text-muted); margin-top: 2px; }

        .steps-grid {
            display: grid;
            grid-template-columns: repeat(16, 1fr);
            gap: 4px;
            flex: 1;
            margin-left: 20px;
        }

        .step {
            height: 40px;
            background: #2a2a35;
            border-radius: 2px;
            cursor: pointer;
            position: relative;
        }
        .step:nth-child(4n+1) { background: #323240; } /* Beat markers */
        
        .step.active {
            background: var(--secondary);
            box-shadow: 0 0 10px var(--secondary);
        }
        .step.active.kick { background: var(--danger); box-shadow: 0 0 10px var(--danger); }
        .step.active.snare { background: var(--primary); box-shadow: 0 0 10px var(--primary); }
        
        .step.playing { border: 2px solid white; z-index: 2; }

        /* --- 3. MIXER & FX PANEL (Bottom) --- */
        .mixer-panel {
            background: #151518;
            border-top: 1px solid #333;
            display: flex;
            overflow-x: auto;
            padding: 15px;
            gap: 10px;
        }

        .channel-strip {
            min-width: 100px;
            background: #1e1e24;
            border-radius: 4px;
            padding: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            border: 1px solid #2a2a35;
            position: relative;
        }
        
        .channel-strip.master { border: 1px solid var(--primary); background: #1a221f; }

        .channel-name { font-size: 12px; margin-bottom: 10px; font-weight: bold; color: var(--text-muted); }
        
        /* Knobs (CSS Only) */
        .knob-container {
            margin: 5px 0;
            text-align: center;
        }
        .knob-label { font-size: 9px; color: #666; margin-bottom: 2px; display: block; }
        
        input[type=range].fader {
            -webkit-appearance: none; 
            width: 120px; /* Döndürülecek */
            height: 6px;
            background: #333;
            border-radius: 3px;
            outline: none;
            transform: rotate(-90deg);
            margin: 60px 0; /* Rotation boşluğu */
        }
        
        input[type=range].fader::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 12px;
            height: 20px;
            background: var(--text-main);
            border-radius: 2px;
            cursor: pointer;
            box-shadow: 0 0 5px rgba(0,0,0,0.5);
        }

        /* Tiny Knobs for EQ/FX */
        .fx-rack {
            display: flex;
            flex-direction: column;
            gap: 5px;
            width: 100%;
            background: #00000030;
            padding: 5px;
            border-radius: 4px;
            margin-bottom: 5px;
        }
        
        .fx-row { display: flex; justify-content: space-between; align-items: center; }
        .fx-name { font-size: 9px; color: var(--secondary); }
        
        input[type=range].mini-knob {
            width: 60px;
            height: 2px;
        }

        .meter {
            width: 6px;
            height: 100px;
            background: #000;
            margin-left: 5px;
            position: absolute;
            right: 10px;
            bottom: 40px;
            border-radius: 3px;
            overflow: hidden;
            display: flex;
            flex-direction: column-reverse;
        }
        .meter-fill {
            width: 100%;
            background: linear-gradient(to top, #00ff00, #ffff00, #ff0000);
            height: 0%;
            transition: height 0.05s;
        }

        /* Visualizer Overlay */
        #visualizer {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 280px;
            pointer-events: none;
            opacity: 0.1;
            z-index: 0;
        }
    </style>
</head>
<body>

    <header>
        <div class="logo">R0Y<span>PAD</span> <small style="font-size:10px; color:#666;">STUDIO EDITION</small></div>
        
        <div class="transport">
            <button class="btn" id="clearBtn">TEMİZLE</button>
            <div style="display:flex; flex-direction:column; align-items:center;">
                <span style="font-size:9px; color:#666;">BPM</span>
                <input type="number" id="bpmInput" class="lcd-display" value="130" min="60" max="200">
            </div>
            <button class="btn stop" id="stopBtn">■ STOP</button>
            <button class="btn play" id="playBtn">▶ PLAY</button>
        </div>
        
        <div style="font-size: 10px; color: #555;">v2.0.4 BUILD</div>
    </header>

    <div class="rack-container" id="rackContainer">
        </div>

    <canvas id="visualizer"></canvas>
    <div class="mixer-panel" id="mixerPanel">
        </div>

<script>
    /**
     * R0YPAD AUDIO ENGINE V2
     * Features: Per-Channel FX Chain, EQ, Drive, Master Bus
     */
    
    const AudioContext = window.AudioContext || window.webkitAudioContext;
    const ctx = new AudioContext();

    // --- EFFECT UNITS (Sananal Pluginler) --- //

    // 1. Distortion Effect
    function makeDistortionCurve(amount) {
        const k = typeof amount === 'number' ? amount : 50,
            n_samples = 44100,
            curve = new Float32Array(n_samples),
            deg = Math.PI / 180;
        for (let i = 0; i < n_samples; ++i) {
            let x = i * 2 / n_samples - 1;
            curve[i] = (3 + k) * x * 20 * deg / (Math.PI + k * Math.abs(x));
        }
        return curve;
    }

    // 2. Simple Delay (Echo)
    class SimpleDelay {
        constructor(context) {
            this.input = context.createGain();
            this.delay = context.createDelay();
            this.feedback = context.createGain();
            this.output = context.createGain();
            this.wet = context.createGain();

            this.delay.delayTime.value = 0.3; // 300ms
            this.feedback.gain.value = 0.4;
            this.wet.gain.value = 0.0; // Default off

            // Routing: Input -> Output (Dry) & Input -> Delay -> Feedback -> Delay -> Output (Wet)
            this.input.connect(this.output); // Dry signal
            this.input.connect(this.delay);
            this.delay.connect(this.feedback);
            this.feedback.connect(this.delay);
            this.delay.connect(this.wet);
            this.wet.connect(this.output);
        }
    }

    // --- CHANNEL STRIP CLASS --- //
    class ChannelStrip {
        constructor(name, type, color, index) {
            this.name = name;
            this.type = type; // kick, snare, synth, etc.
            this.color = color;
            this.index = index;
            this.steps = new Array(16).fill(false);
            
            // Audio Chain: Source -> Drive -> EQ -> Volume -> Pan -> DelaySend -> Master
            this.gainNode = ctx.createGain(); // Volume Fader
            this.panNode = ctx.createStereoPanner();
            
            // EQ
            this.lowShelf = ctx.createBiquadFilter();
            this.lowShelf.type = "lowshelf";
            this.lowShelf.frequency.value = 320;
            
            this.highShelf = ctx.createBiquadFilter();
            this.highShelf.type = "highshelf";
            this.highShelf.frequency.value = 3200;

            // Distortion (Drive)
            this.shaper = ctx.createWaveShaper();
            this.shaper.curve = makeDistortionCurve(0); // Init 0
            
            // Delay Unit
            this.delayUnit = new SimpleDelay(ctx);

            // Connect Chain
            // Note: Source connects to shaper in play function
            this.shaper.connect(this.lowShelf);
            this.lowShelf.connect(this.highShelf);
            this.highShelf.connect(this.delayUnit.input);
            this.delayUnit.output.connect(this.gainNode);
            this.gainNode.connect(this.panNode);
            this.panNode.connect(masterLimiter); // To Master

            // Default Values
            this.gainNode.gain.value = 0.7;
        }

        playSound(time) {
            const osc = ctx.createOscillator();
            const env = ctx.createGain();
            
            // Sound Synthesis Definitions
            if (this.type === 'kick') {
                osc.frequency.setValueAtTime(150, time);
                osc.frequency.exponentialRampToValueAtTime(0.01, time + 0.5);
                env.gain.setValueAtTime(1, time);
                env.gain.exponentialRampToValueAtTime(0.01, time + 0.5);
                osc.connect(env);
            } 
            else if (this.type === 'snare') {
                // Noise buffer for snare
                const bSize = ctx.sampleRate * 0.2;
                const buffer = ctx.createBuffer(1, bSize, ctx.sampleRate);
                const data = buffer.getChannelData(0);
                for(let i=0; i<bSize; i++) data[i] = Math.random() * 2 - 1;
                
                const noise = ctx.createBufferSource();
                noise.buffer = buffer;
                const noiseFilt = ctx.createBiquadFilter();
                noiseFilt.type = 'highpass';
                noiseFilt.frequency.value = 1000;
                noise.connect(noiseFilt);
                noiseFilt.connect(env);
                
                env.gain.setValueAtTime(1, time);
                env.gain.exponentialRampToValueAtTime(0.01, time + 0.2);
                noise.start(time);
            }
            else if (this.type === 'hat') {
                // Metalic Square arrays
                osc.type = 'square';
                // Bandpass
                const filter = ctx.createBiquadFilter();
                filter.type = 'bandpass';
                filter.frequency.value = 10000;
                osc.connect(filter);
                filter.connect(env);
                
                osc.frequency.setValueAtTime(8000, time);
                env.gain.setValueAtTime(0.3, time); // Lower vol
                env.gain.exponentialRampToValueAtTime(0.01, time + 0.05);
            }
            else if (this.type === 'bass') {
                osc.type = 'sawtooth';
                const filter = ctx.createBiquadFilter();
                filter.type = 'lowpass';
                filter.frequency.setValueAtTime(600, time);
                filter.frequency.exponentialRampToValueAtTime(100, time + 0.2);
                osc.connect(filter);
                filter.connect(env);
                
                osc.frequency.setValueAtTime(55, time);
                env.gain.setValueAtTime(0.6, time);
                env.gain.linearRampToValueAtTime(0, time + 0.4);
            }
            else if (this.type === 'synth') {
                osc.type = 'triangle';
                osc.frequency.setValueAtTime(440, time); // A4
                // Simple arpeggio logic simulation could go here
                if(currentStep % 4 === 0) osc.frequency.setValueAtTime(330, time); // E4
                
                env.gain.setValueAtTime(0.4, time);
                env.gain.linearRampToValueAtTime(0, time + 0.3);
                osc.connect(env);
            }
            else if (this.type === 'clap') {
                 // Noise burst
                const bSize = ctx.sampleRate * 0.15;
                const buffer = ctx.createBuffer(1, bSize, ctx.sampleRate);
                const data = buffer.getChannelData(0);
                for(let i=0; i<bSize; i++) data[i] = Math.random() * 2 - 1;
                const noise = ctx.createBufferSource();
                noise.buffer = buffer;
                
                env.gain.setValueAtTime(0.5, time);
                env.gain.exponentialRampToValueAtTime(0.01, time + 0.1);
                noise.connect(env);
                noise.start(time);
            }

            // Connect Envelope to Channel Strip Input (Distortion/Shaper)
            if(this.type === 'snare' || this.type === 'clap') {
                // BufferSources don't use osc.start/stop the same way, handled above
            } else {
                osc.start(time);
                osc.stop(time + (this.type==='bass'?0.5:0.2));
            }
            
            // Visual Meter Trigger
            setTimeout(() => {
                const meter = document.getElementById(`meter-${this.index}`);
                if(meter) {
                    meter.style.height = (this.gainNode.gain.value * 100) + '%';
                    setTimeout(() => meter.style.height = '0%', 150);
                }
            }, (time - ctx.currentTime) * 1000);

            env.connect(this.shaper);
        }
    }

    // --- MASTER BUS ---
    const masterLimiter = ctx.createDynamicsCompressor();
    masterLimiter.threshold.value = -10;
    masterLimiter.ratio.value = 12;
    
    const masterGain = ctx.createGain();
    masterGain.gain.value = 0.8;
    
    const analyser = ctx.createAnalyser();
    analyser.fftSize = 256;

    masterLimiter.connect(masterGain);
    masterGain.connect(analyser);
    analyser.connect(ctx.destination);

    // --- INITIALIZATION ---
    const tracksData = [
        { name: 'KICK 808', type: 'kick', color: 'danger' },
        { name: 'SNARE TRAP', type: 'snare', color: 'primary' },
        { name: 'HI-HAT CLSD', type: 'hat', color: 'secondary' },
        { name: 'CLAP', type: 'clap', color: 'secondary' },
        { name: 'BASS LINE', type: 'bass', color: 'danger' },
        { name: 'LEAD SYNTH', type: 'synth', color: 'primary' }
    ];

    const channels = tracksData.map((t, i) => new ChannelStrip(t.name, t.type, t.color, i));

    // --- UI BUILDER ---
    const rackContainer = document.getElementById('rackContainer');
    const mixerPanel = document.getElementById('mixerPanel');

    function initUI() {
        // Build Rack
        channels.forEach((ch, idx) => {
            // 1. Sequencer Row
            const row = document.createElement('div');
            row.className = `track-row ${idx === 0 ? 'selected' : ''}`;
            row.onclick = () => {
                 document.querySelectorAll('.track-row').forEach(r => r.classList.remove('selected'));
                 row.classList.add('selected');
                 // Scroll mixer to channel? (Optional)
            };

            const info = document.createElement('div');
            info.className = 'track-info';
            info.innerHTML = `<span>${ch.name}</span><span class="track-type">${ch.type.toUpperCase()}</span>`;
            
            const grid = document.createElement('div');
            grid.className = 'steps-grid';

            ch.steps.forEach((isActive, stepIdx) => {
                const step = document.createElement('div');
                step.className = `step step-col-${stepIdx} ${isActive ? 'active ' + ch.color : ''}`;
                step.onclick = (e) => {
                    e.stopPropagation();
                    ch.steps[stepIdx] = !ch.steps[stepIdx];
                    step.className = `step step-col-${stepIdx} ${ch.steps[stepIdx] ? 'active ' + ch.color : ''}`;
                };
                grid.appendChild(step);
            });

            row.appendChild(info);
            row.appendChild(grid);
            rackContainer.appendChild(row);

            // 2. Mixer Channel
            const strip = document.createElement('div');
            strip.className = 'channel-strip';
            strip.innerHTML = `
                <div class="channel-name">${ch.name.split(' ')[0]}</div>
                
                <div class="fx-rack">
                    <div class="fx-row">
                        <span class="fx-name">DRIVE</span>
                        <input type="range" class="mini-knob" min="0" max="100" value="0" 
                            oninput="updateDrive(${idx}, this.value)">
                    </div>
                    <div class="fx-row">
                        <span class="fx-name">DELAY</span>
                        <input type="range" class="mini-knob" min="0" max="1" step="0.1" value="0" 
                            oninput="updateDelay(${idx}, this.value)">
                    </div>
                    <div class="fx-row">
                        <span class="fx-name">HIGH</span>
                        <input type="range" class="mini-knob" min="-10" max="10" value="0" 
                            oninput="updateEQ(${idx}, 'high', this.value)">
                    </div>
                    <div class="fx-row">
                        <span class="fx-name">LOW</span>
                        <input type="range" class="mini-knob" min="-10" max="10" value="0" 
                            oninput="updateEQ(${idx}, 'low', this.value)">
                    </div>
                </div>

                <div class="knob-container">
                    <span class="knob-label">PAN</span>
                    <input type="range" min="-1" max="1" step="0.1" value="0" style="width:50px"
                        oninput="updatePan(${idx}, this.value)">
                </div>

                <div style="position:relative; height: 140px; display:flex; justify-content:center;">
                    <input type="range" class="fader" min="0" max="1" step="0.01" value="0.7" 
                        oninput="updateVol(${idx}, this.value)">
                    <div class="meter"><div class="meter-fill" id="meter-${idx}"></div></div>
                </div>
                
                <div class="knob-label">${idx + 1}</div>
            `;
            mixerPanel.appendChild(strip);
        });

        // Add Master Channel
        const masterStrip = document.createElement('div');
        masterStrip.className = 'channel-strip master';
        masterStrip.innerHTML = `
            <div class="channel-name" style="color:var(--primary)">MASTER</div>
            <div style="height: 90px;"></div> <div style="position:relative; height: 140px; display:flex; justify-content:center;">
                <input type="range" class="fader" min="0" max="1.2" step="0.01" value="0.8" 
                    oninput="masterGain.gain.value = this.value">
            </div>
        `;
        mixerPanel.appendChild(masterStrip);
    }

    // --- MIXER LOGIC ---
    window.updateVol = (idx, val) => channels[idx].gainNode.gain.value = val;
    window.updatePan = (idx, val) => channels[idx].panNode.pan.value = val;
    window.updateDrive = (idx, val) => channels[idx].shaper.curve = makeDistortionCurve(parseInt(val));
    window.updateEQ = (idx, type, val) => {
        if(type === 'high') channels[idx].highShelf.gain.value = val;
        else channels[idx].lowShelf.gain.value = val;
    };
    window.updateDelay = (idx, val) => channels[idx].delayUnit.wet.gain.value = val;


    // --- SEQUENCER ENGINE ---
    let isPlaying = false;
    let currentStep = 0;
    let nextNoteTime = 0.0;
    let tempo = 130;
    let timerID;

    function nextNote() {
        const secondsPerBeat = 60.0 / tempo;
        nextNoteTime += 0.25 * secondsPerBeat;
        currentStep = (currentStep + 1) % 16;
    }

    function scheduleNote(stepNumber, time) {
        // Visual Sync
        setTimeout(() => {
            document.querySelectorAll('.step').forEach(s => s.classList.remove('playing'));
            document.querySelectorAll(`.step-col-${stepNumber}`).forEach(s => s.classList.add('playing'));
        }, (time - ctx.currentTime) * 1000);

        // Audio Trigger
        channels.forEach(ch => {
            if (ch.steps[stepNumber]) {
                ch.playSound(time);
            }
        });
    }

    function scheduler() {
        while (nextNoteTime < ctx.currentTime + 0.1) {
            scheduleNote(currentStep, nextNoteTime);
            nextNote();
        }
        timerID = setTimeout(scheduler, 25);
    }

    // --- CONTROLS ---
    document.getElementById('playBtn').addEventListener('click', function() {
        if(ctx.state === 'suspended') ctx.resume();
        
        if (!isPlaying) {
            isPlaying = true;
            this.classList.add('active');
            currentStep = 0;
            nextNoteTime = ctx.currentTime + 0.05;
            scheduler();
        }
    });

    document.getElementById('stopBtn').addEventListener('click', function() {
        isPlaying = false;
        document.getElementById('playBtn').classList.remove('active');
        clearTimeout(timerID);
        document.querySelectorAll('.step').forEach(s => s.classList.remove('playing'));
    });
    
    document.getElementById('bpmInput').addEventListener('change', (e) => tempo = e.target.value);
    
    document.getElementById('clearBtn').addEventListener('click', () => {
        channels.forEach(ch => {
            ch.steps.fill(false);
            // Re-render grids? Simplest is reload, but lets manually clear visual classes
            document.querySelectorAll('.step').forEach(s => {
                s.classList.remove('active');
                s.classList.remove('danger');
                s.classList.remove('primary');
                s.classList.remove('secondary');
            });
        });
    });

    // --- VISUALIZER ---
    const vCanvas = document.getElementById('visualizer');
    const vCtx = vCanvas.getContext('2d');
    
    function draw() {
        requestAnimationFrame(draw);
        
        vCanvas.width = window.innerWidth;
        vCanvas.height = 300;
        
        const bufferLength = analyser.frequencyBinCount;
        const dataArray = new Uint8Array(bufferLength);
        analyser.getByteFrequencyData(dataArray);

        vCtx.clearRect(0, 0, vCanvas.width, vCanvas.height);
        
        const barWidth = (vCanvas.width / bufferLength) * 2.5;
        let barHeight;
        let x = 0;

        for(let i = 0; i < bufferLength; i++) {
            barHeight = dataArray[i];
            vCtx.fillStyle = `rgba(0, 255, 157, ${barHeight/255})`;
            vCtx.fillRect(x, vCanvas.height - barHeight, barWidth, barHeight);
            x += barWidth + 1;
        }
    }

    // Start
    initUI();
    draw();

</script>
</body>
</html>
